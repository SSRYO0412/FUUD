//
//  HealthMetricsGridSection.swift
//  AWStest
//
//  å¥åº·æŒ‡æ¨™ã‚°ãƒªãƒƒãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ2x2ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
//

import SwiftUI

struct HealthMetricsGridSection: View {
    @StateObject private var bloodTestService = BloodTestService.shared
    @StateObject private var healthScoreService = HealthScoreService.shared

    var body: some View {
        VStack(spacing: 12) {
            // ä¸Šã®è¡Œ: ä»£è¬åŠ› + ç‚ç—‡ãƒ¬ãƒ™ãƒ«
            HStack(spacing: 12) {
                // å·¦ä¸Š: ä»£è¬åŠ› (æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•)
                HealthMetricCard(
                    title: "ä»£è¬åŠ›",
                    iconName: "flame.circle",
                    scoreValue: String(format: "%.0f", metabolicScore * 100),
                    scoreUnit: "%",
                    statusText: metabolicStatus,
                    statusColor: metabolicColor,
                    visualType: .lineChart,
                    progress: metabolicScore,
                    chartDataPoints: metabolicChartData
                )
                .frame(maxWidth: .infinity)
                .frame(height: 130)
                .onAppear {
                    print("ğŸ”¥ ä»£è¬åŠ›: progress=\(metabolicScore), chartData=\(metabolicChartData)")
                }

                // å³ä¸Š: ç‚ç—‡ãƒ¬ãƒ™ãƒ« (åŠå††ã‚²ãƒ¼ã‚¸)
                HealthMetricCard(
                    title: "ç‚ç—‡ãƒ¬ãƒ™ãƒ«",
                    iconName: "shield.circle",
                    scoreValue: String(format: "%.0f", inflammationScore * 100),
                    scoreUnit: "%",
                    statusText: inflammationStatus,
                    statusColor: inflammationColor,
                    visualType: .semiCircleGauge,
                    progress: inflammationScore
                )
                .frame(maxWidth: .infinity)
                .frame(height: 130)
                .onAppear {
                    print("ğŸ›¡ï¸ ç‚ç—‡ãƒ¬ãƒ™ãƒ«: progress=\(inflammationScore)")
                }
            }

            // ä¸‹ã®è¡Œ: å›å¾©ã‚¹ãƒ”ãƒ¼ãƒ‰ + è€åŒ–é€Ÿåº¦
            HStack(spacing: 12) {
                // å·¦ä¸‹: å›å¾©ã‚¹ãƒ”ãƒ¼ãƒ‰ (æ¨ªãƒãƒ¼)
                HealthMetricCard(
                    title: "å›å¾©ã‚¹ãƒ”ãƒ¼ãƒ‰",
                    iconName: "arrow.clockwise.circle",
                    scoreValue: String(format: "%.0f", recoveryScore * 100),
                    scoreUnit: "%",
                    statusText: recoveryStatus,
                    statusColor: recoveryColor,
                    visualType: .horizontalBar,
                    progress: recoveryScore
                )
                .frame(maxWidth: .infinity)
                .frame(height: 130)
                .offset(y: 50)
                .onAppear {
                    print("ğŸ”„ å›å¾©ã‚¹ãƒ”ãƒ¼ãƒ‰: progress=\(recoveryScore)")
                }

                // å³ä¸‹: è€åŒ–é€Ÿåº¦ (æ¨ªãƒãƒ¼)
                HealthMetricCard(
                    title: "è€åŒ–é€Ÿåº¦",
                    iconName: "chart.line.uptrend.xyaxis.circle",
                    scoreValue: String(format: "%.1f", agingRate),
                    scoreUnit: "æ­³/å¹´",
                    statusText: agingRateStatus,
                    statusColor: agingRateColor,
                    visualType: .horizontalBar,
                    progress: agingRateProgress
                )
                .frame(maxWidth: .infinity)
                .frame(height: 130)
                .offset(y: 50)
                .onAppear {
                    print("ğŸ“ˆ è€åŒ–é€Ÿåº¦è©³ç´°:")
                    print("  - agingScore: \(String(format: "%.2f", agingScore))")
                    print("  - agingRate: \(String(format: "%.2f", agingRate))æ­³/å¹´")
                    print("  - agingRateProgress: \(String(format: "%.2f", agingRateProgress))")
                    print("  - è¡¨ç¤ºå€¤: \(String(format: "%.1f", agingRate))æ­³/å¹´")
                    print("  - ãƒãƒ¼å¹…: \(String(format: "%.0f", agingRateProgress * 100))%")
                }
            }
        }
        .frame(maxWidth: .infinity)
    }

    // MARK: - Computed Properties

    /// ä»£è¬åŠ›ã‚¹ã‚³ã‚¢ï¼ˆHbA1cã€TGã‹ã‚‰è¨ˆç®—ï¼‰
    private var metabolicScore: Double {
        guard let bloodData = bloodTestService.bloodData else {
            print("âš ï¸ ä»£è¬åŠ›: è¡€æ¶²æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿ãªã—")
            return 0.35
        }

        // HbA1c: 5.6%ä»¥ä¸‹ãŒæ­£å¸¸
        let hba1c = bloodData.bloodItems.first { item in
            let key = item.key.lowercased()
            return key.contains("hba1c") || key == "hemoglobin_a1c"
        }

        guard let hba1cValue = hba1c?.value.replacingOccurrences(of: " ", with: ""),
              let hba1cNum = Double(hba1cValue) else {
            print("âš ï¸ ä»£è¬åŠ›: HbA1cãƒ‡ãƒ¼ã‚¿ãªã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨")
            return 0.35
        }
        print("âœ… ä»£è¬åŠ›: HbA1c = \(hba1cNum)%")

        // HbA1c: 5.6%ä»¥ä¸‹ãŒæ­£å¸¸ã€6.5%ä»¥ä¸ŠãŒç³–å°¿ç—…åŸŸ
        let hba1cScore = max(0, min(1, (6.5 - hba1cNum) / 1.0))

        // TG: 150ä»¥ä¸‹ãŒæ­£å¸¸
        let tg = bloodData.bloodItems.first { item in
            let key = item.key.lowercased()
            return key == "tg" || key == "triglyceride"
        }

        if let tgValue = tg?.value.replacingOccurrences(of: " ", with: ""),
           let tgNum = Double(tgValue) {
            print("âœ… ä»£è¬åŠ›: TG = \(tgNum) mg/dL")
            let tgScore = max(0, min(1, (150 - tgNum) / 100))
            return (hba1cScore + tgScore) / 2
        } else {
            print("âš ï¸ ä»£è¬åŠ›: TGãƒ‡ãƒ¼ã‚¿ãªã—ã€HbA1cã®ã¿ã§è¨ˆç®—")
            return hba1cScore
        }
    }

    private var metabolicStatus: String {
        if metabolicScore >= 0.7 { return "é«˜" }
        if metabolicScore >= 0.4 { return "ä¸­" }
        return "ä½"
    }

    private var metabolicColor: Color {
        if metabolicScore >= 0.7 { return Color(hex: "00C853") }
        if metabolicScore >= 0.4 { return Color(hex: "FFCB05") }
        return Color(hex: "5E7CE2")
    }

    /// ç‚ç—‡ãƒ¬ãƒ™ãƒ«ï¼ˆCRPã‚’ãƒ¡ã‚¤ãƒ³æŒ‡æ¨™ã¨ã—ã¦ä½¿ç”¨ï¼‰
    private var inflammationScore: Double {
        guard let bloodData = bloodTestService.bloodData else {
            print("âš ï¸ ç‚ç—‡ãƒ¬ãƒ™ãƒ«: è¡€æ¶²æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿ãªã—")
            return 0.4
        }

        let crp = bloodData.bloodItems.first { item in
            let key = item.key.lowercased()
            return key == "crp" || key == "c_reactive_protein"
        }

        guard let crpValue = crp?.value.replacingOccurrences(of: " ", with: ""),
              let crpNum = Double(crpValue) else {
            print("âš ï¸ ç‚ç—‡ãƒ¬ãƒ™ãƒ«: CRPãƒ‡ãƒ¼ã‚¿ãªã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨")
            return 0.4
        }
        print("âœ… ç‚ç—‡ãƒ¬ãƒ™ãƒ«: CRP = \(crpNum) mg/dL")

        // CRP: 0.3ä»¥ä¸‹ãŒæ­£å¸¸ã€å€¤ãŒä½ã„ã»ã©è‰¯ã„
        return max(0, min(1, (0.5 - crpNum) / 0.5))
    }

    private var inflammationStatus: String {
        if inflammationScore >= 0.7 { return "çŠ¶æ…‹æ­£å¸¸" }
        if inflammationScore >= 0.4 { return "æ³¨æ„" }
        return "é«˜ã„"
    }

    private var inflammationColor: Color {
        if inflammationScore >= 0.7 { return Color(hex: "5E7CE2") }
        if inflammationScore >= 0.4 { return Color(hex: "FFCB05") }
        return Color(hex: "ED1C24")
    }

    /// å›å¾©ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ˆCRPã€CKã€ãƒ•ã‚§ãƒªãƒãƒ³ã‹ã‚‰ç®—å‡ºï¼‰
    private var recoveryScore: Double {
        guard let bloodData = bloodTestService.bloodData else {
            print("âš ï¸ å›å¾©ã‚¹ãƒ”ãƒ¼ãƒ‰: è¡€æ¶²æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿ãªã—")
            return 0.71
        }

        var scores: [Double] = []

        // CRP: 0.3ä»¥ä¸‹ãŒæ­£å¸¸
        if let crp = bloodData.bloodItems.first(where: { $0.key.lowercased() == "crp" }) {
            let crpValue = crp.value.replacingOccurrences(of: " ", with: "")
            if let crpNum = Double(crpValue) {
                print("âœ… å›å¾©ã‚¹ãƒ”ãƒ¼ãƒ‰: CRP = \(crpNum) mg/dL")
                let crpScore = max(0, min(1, (0.3 - crpNum) / 0.3))
                scores.append(crpScore)
            }
        }

        // CK: 200ä»¥ä¸‹ãŒæ­£å¸¸
        if let ck = bloodData.bloodItems.first(where: { item in
            let key = item.key.lowercased()
            return key == "ck" || key == "cpk" || key == "creatine_kinase"
        }) {
            let ckValue = ck.value.replacingOccurrences(of: " ", with: "")
            if let ckNum = Double(ckValue) {
                print("âœ… å›å¾©ã‚¹ãƒ”ãƒ¼ãƒ‰: CK = \(ckNum) U/L")
                let ckScore = max(0, min(1, (200 - ckNum) / 150))
                scores.append(ckScore)
            }
        }

        // ãƒ•ã‚§ãƒªãƒãƒ³: 50-100ãŒé©æ­£
        if let ferritin = bloodData.bloodItems.first(where: { $0.key.lowercased() == "ferritin" }) {
            let ferritinValue = ferritin.value.replacingOccurrences(of: " ", with: "")
            if let ferritinNum = Double(ferritinValue) {
                print("âœ… å›å¾©ã‚¹ãƒ”ãƒ¼ãƒ‰: ãƒ•ã‚§ãƒªãƒãƒ³ = \(ferritinNum) ng/mL")
                let ferritinScore = min(1, ferritinNum / 100)
                scores.append(ferritinScore)
            }
        }

        if scores.isEmpty {
            print("âš ï¸ å›å¾©ã‚¹ãƒ”ãƒ¼ãƒ‰: å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãªã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨")
            return 0.71
        }

        let average = scores.reduce(0, +) / Double(scores.count)
        print("âœ… å›å¾©ã‚¹ãƒ”ãƒ¼ãƒ‰è¨ˆç®—å®Œäº†: \(String(format: "%.2f", average * 100))%")
        return average
    }

    private var recoveryStatus: String {
        if recoveryScore >= 0.7 { return "æº–å‚™å®Œäº†" }
        if recoveryScore >= 0.4 { return "å›å¾©ä¸­" }
        return "ç–²åŠ´"
    }

    private var recoveryColor: Color {
        if recoveryScore >= 0.7 { return Color(hex: "4FC0D0") }
        if recoveryScore >= 0.4 { return Color(hex: "FFCB05") }
        return Color(hex: "ED1C24")
    }

    /// è€åŒ–é€Ÿåº¦ï¼ˆHbA1cã€CRPã€ALBã€CREã‹ã‚‰ç®—å‡ºï¼‰
    private var agingScore: Double {
        guard let bloodData = bloodTestService.bloodData else {
            print("âš ï¸ è€åŒ–é€Ÿåº¦: è¡€æ¶²æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿ãªã—")
            return 0.43
        }

        var scores: [Double] = []

        // HbA1c: 5.6%ä»¥ä¸‹ãŒæ­£å¸¸
        if let hba1c = bloodData.bloodItems.first(where: { item in
            let key = item.key.lowercased()
            return key.contains("hba1c") || key == "hemoglobin_a1c"
        }) {
            let hba1cValue = hba1c.value.replacingOccurrences(of: " ", with: "")
            if let hba1cNum = Double(hba1cValue) {
                print("âœ… è€åŒ–é€Ÿåº¦: HbA1c = \(hba1cNum)%")
                let hba1cScore = max(0, min(1, (6.5 - hba1cNum) / 1.0))
                scores.append(hba1cScore)
            }
        }

        // CRP: 0.3ä»¥ä¸‹ãŒæ­£å¸¸
        if let crp = bloodData.bloodItems.first(where: { $0.key.lowercased() == "crp" }) {
            let crpValue = crp.value.replacingOccurrences(of: " ", with: "")
            if let crpNum = Double(crpValue) {
                print("âœ… è€åŒ–é€Ÿåº¦: CRP = \(crpNum) mg/dL")
                let crpScore = max(0, min(1, (0.3 - crpNum) / 0.3))
                scores.append(crpScore)
            }
        }

        // ALB: 3.5-5.0ãŒæ­£å¸¸
        if let alb = bloodData.bloodItems.first(where: { item in
            let key = item.key.lowercased()
            return key == "alb" || key == "albumin"
        }) {
            let albValue = alb.value.replacingOccurrences(of: " ", with: "")
            if let albNum = Double(albValue) {
                print("âœ… è€åŒ–é€Ÿåº¦: ALB = \(albNum) g/dL")
                let albScore = max(0, min(1, (albNum - 3.5) / 1.5))
                scores.append(albScore)
            }
        }

        // CRE: 0.6-1.2ãŒæ­£å¸¸
        if let cre = bloodData.bloodItems.first(where: { item in
            let key = item.key.lowercased()
            return key == "cre" || key == "creatinine"
        }) {
            let creValue = cre.value.replacingOccurrences(of: " ", with: "")
            if let creNum = Double(creValue) {
                print("âœ… è€åŒ–é€Ÿåº¦: CRE = \(creNum) mg/dL")
                let creScore = max(0, min(1, (1.2 - creNum) / 0.5))
                scores.append(creScore)
            }
        }

        if scores.isEmpty {
            print("âš ï¸ è€åŒ–é€Ÿåº¦: å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãªã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨")
            return 0.43
        }

        let average = scores.reduce(0, +) / Double(scores.count)
        print("âœ… è€åŒ–é€Ÿåº¦è¨ˆç®—å®Œäº†: \(String(format: "%.2f", average * 100))%")
        return average
    }

    private var agingStatus: String {
        if agingScore >= 0.7 { return "å„ªç§€" }
        if agingScore >= 0.4 { return "æ™®é€š" }
        return "ä½ã„"
    }

    private var agingColor: Color {
        if agingScore >= 0.7 { return Color(hex: "00C853") }
        if agingScore >= 0.4 { return Color(hex: "FFCB05") }
        return Color(hex: "ED1C24")
    }

    /// ä»£è¬åŠ›ã®ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆéå»7æ—¥é–“ï¼‰
    private var metabolicChartData: [Double] {
        let currentValue = metabolicScore * 100
        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®ã¿ï¼ˆéå»ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼‰
        return [currentValue]
    }

    /// è€åŒ–é€Ÿåº¦ï¼ˆæ­³/å¹´ï¼‰ã‚’è¨ˆç®—
    private var agingRate: Double {
        // agingScoreã¯0-1ã®ç¯„å›²ã§ã€1ãŒæœ€è‰¯ï¼ˆè€åŒ–ãŒé…ã„ï¼‰ã€0ãŒæœ€æ‚ªï¼ˆè€åŒ–ãŒé€Ÿã„ï¼‰
        // è€åŒ–é€Ÿåº¦ = 2.0 - (agingScore * 1.5)
        // agingScore=1.0 â†’ 0.5æ­³/å¹´ï¼ˆéå¸¸ã«é…ã„è€åŒ–ï¼‰
        // agingScore=0.67 â†’ 1.0æ­³/å¹´ï¼ˆæ¨™æº–çš„ãªè€åŒ–ï¼‰
        // agingScore=0 â†’ 2.0æ­³/å¹´ï¼ˆéå¸¸ã«é€Ÿã„è€åŒ–ï¼‰
        let rate = 2.0 - (agingScore * 1.5)
        print("âœ… è€åŒ–é€Ÿåº¦: \(String(format: "%.2f", rate))æ­³/å¹´ (ã‚¹ã‚³ã‚¢: \(String(format: "%.2f", agingScore * 100))%)")
        return rate
    }

    private var agingRateStatus: String {
        if agingRate <= 0.8 { return "å„ªç§€" }
        if agingRate <= 1.2 { return "æ¨™æº–" }
        return "æ³¨æ„"
    }

    private var agingRateColor: Color {
        if agingRate <= 0.8 { return Color(hex: "00C853") }
        if agingRate <= 1.2 { return Color(hex: "FFCB05") }
        return Color(hex: "ED1C24")
    }

    /// è€åŒ–é€Ÿåº¦ã®æ¨ªãƒãƒ¼ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ï¼ˆ0-1ï¼‰
    private var agingRateProgress: Double {
        // 0.5æ­³/å¹´ â†’ 1.0 (æœ€è‰¯)
        // 1.0æ­³/å¹´ â†’ 0.67 (æ¨™æº–)
        // 2.0æ­³/å¹´ â†’ 0.0 (æœ€æ‚ª)
        return max(0, min(1, (2.0 - agingRate) / 1.5))
    }
}

#if DEBUG
struct HealthMetricsGridSection_Previews: PreviewProvider {
    static var previews: some View {
        ZStack {
            LinearGradient(
                colors: [Color(hex: "FAFAFA"), Color(hex: "F0F0F0")],
                startPoint: .topLeading,
                endPoint: .bottomTrailing
            )
            .ignoresSafeArea()

            ScrollView {
                HealthMetricsGridSection()
                    .padding(.top, 20)
            }
        }
    }
}
#endif
