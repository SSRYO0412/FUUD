//
//  GeneCategoryGroup.swift
//  TUUN
//
//  å¤§ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆãƒ€ã‚¤ã‚¨ãƒƒãƒˆãƒ»ç”Ÿæ´»ç¿’æ…£ãƒ»é‹å‹•ãƒ»é•·å¯¿ï¼‰ã®ã‚°ãƒ«ãƒ¼ãƒ—å®šç¾©
//

import Foundation

/// å¤§ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—
struct GeneCategoryGroup: Identifiable {
    let id = UUID()
    let name: String           // å¤§ã‚«ãƒ†ã‚´ãƒªãƒ¼å
    let icon: String           // ã‚¢ã‚¤ã‚³ãƒ³å
    let markers: [GeneDataService.GeneticMarker]  // å«ã¾ã‚Œã‚‹å°ã‚«ãƒ†ã‚´ãƒªãƒ¼

    /// å¹³å‡ã‚¹ã‚³ã‚¢ï¼ˆå°ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å¹³å‡ï¼‰
    var averageScore: Int {
        guard !markers.isEmpty else { return 0 }
        let totalScore = markers.compactMap { $0.cachedImpact?.score }.reduce(0, +)
        return totalScore / max(markers.count, 1)
    }

    /// ã‚¹ã‚³ã‚¢ãƒ¬ãƒ™ãƒ«
    var scoreLevel: ScoreLevel {
        switch averageScore {
        case 20...100:
            return .excellent
        case 1...19:
            return .good
        case -19...0:
            return .normal
        default:
            return .needsSupport
        }
    }

    /// ã‚¿ã‚¤ãƒ—åï¼ˆã‚¹ã‚³ã‚¢ã«åŸºã¥ãï¼‰
    var typeName: String {
        return GeneCategoryGroup.typeNames[name]?[scoreLevel] ?? "\(name)æ¨™æº–å‹"
    }

    /// éºä¼å­èª¬æ˜ï¼ˆã‚¹ã‚³ã‚¢ã«åŸºã¥ãï¼‰
    var description: String {
        return GeneCategoryGroup.descriptions[name]?[scoreLevel] ?? ""
    }

    // MARK: - ã‚¹ã‚³ã‚¢ãƒ¬ãƒ™ãƒ«å®šç¾©

    enum ScoreLevel: String {
        case excellent = "å„ªä½å‹"
        case good = "ã‚„ã‚„å„ªä½å‹"
        case normal = "æ¨™æº–å‹"
        case needsSupport = "è¦ã‚µãƒãƒ¼ãƒˆå‹"
    }

    // MARK: - å¤§ã‚«ãƒ†ã‚´ãƒªãƒ¼å®šç¾©

    /// å¤§ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨å°ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    static let categoryMapping: [String: [String]] = [
        "ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ": [
            "åŸºç¤ä»£è¬",
            "é™¤è„‚è‚ªä½“é‡",
            "å†…è‡“è„‚è‚ª",
            "é£Ÿæ¬²ã®èª¿ç¯€åŠ›ï¼ˆãƒ¬ãƒ—ãƒãƒ³å€¤ï¼‰",
            "ã‚¤ãƒ³ã‚¹ãƒªãƒ³æŠµæŠ—æ€§",
            "ä¸­æ€§è„‚è‚ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰",
            "LDLã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«ï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰",
            "HDLã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«ï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰",
            "ã‚¢ãƒ‡ã‚£ãƒãƒã‚¯ãƒãƒ³å€¤",
            "è„‚è³ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰",
            "é«˜è„‚è‚ªãƒ€ã‚¤ã‚¨ãƒƒãƒˆåŠ¹æœ",
            "é«˜ãŸã‚“ã±ããƒ€ã‚¤ã‚¨ãƒƒãƒˆåŠ¹æœ",
            "ä¸é£½å’Œè„‚è‚ªé…¸ã®æ‘‚å–åŠ¹æœ"
        ],
        "ç”Ÿæ´»ç¿’æ…£": [
            "çœ ã‚Šã®æ·±ã•",
            "å…¥çœ æ½œæ™‚",
            "æ¦‚æ—¥ãƒªã‚ºãƒ ",
            "æ˜¼é–“ã®çœ æ°—",
            "ã‚«ãƒ•ã‚§ã‚¤ãƒ³ä»£è¬",
            "ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ï¼ˆç²¾ç¥çš„å›å¾©åŠ›ï¼‰"
        ],
        "é‹å‹•": [
            "ç­‹è‚‰ã®ç™ºé”",
            "ç­‹æŒä¹…åŠ›",
            "ç¬ç™ºåŠ›"
        ],
        "é•·å¯¿": [
            "ãƒ†ãƒ­ãƒ¡ã‚¢ã®é•·ã•ï¼ˆç´°èƒè€åŒ–ã®æŒ‡æ¨™ï¼‰",
            "90æ­³ä»¥ä¸Šã¾ã§ç”Ÿãã‚‹å¯èƒ½æ€§",
            "æŠ—é…¸åŒ–åŠ›",
            "hsCRPå€¤ (å…ç–«ç³»ç–¾æ‚£ã®æŒ‡æ¨™ï¼‰",
            "IL-18å€¤ (å…ç–«ç³»ç–¾æ‚£ã®æŒ‡æ¨™ï¼‰",
            "è£œä½“C3/C4å€¤ (å…ç–«ç³»ç–¾æ‚£ã®æŒ‡æ¨™ï¼‰"
        ]
    ]

    /// ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®è¡¨ç¤ºé †åº
    static let categoryOrder: [String] = ["ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ", "ç”Ÿæ´»ç¿’æ…£", "é‹å‹•", "é•·å¯¿"]

    /// ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
    static let categoryIcons: [String: String] = [
        "ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ": "flame.fill",
        "ç”Ÿæ´»ç¿’æ…£": "moon.stars.fill",
        "é‹å‹•": "figure.run",
        "é•·å¯¿": "heart.fill"
    ]

    // MARK: - ã‚¿ã‚¤ãƒ—åå®šç¾©

    static let typeNames: [String: [ScoreLevel: String]] = [
        "ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ": [
            .excellent: "è„‚è‚ªç‡ƒç„¼å„ªä½å‹",
            .good: "ä»£è¬ã‚„ã‚„è‰¯å¥½å‹",
            .normal: "ä»£è¬ãƒãƒ©ãƒ³ã‚¹å‹",
            .needsSupport: "ä»£è¬ã‚µãƒãƒ¼ãƒˆå¿…è¦å‹"
        ],
        "ç”Ÿæ´»ç¿’æ…£": [
            .excellent: "ç¡çœ ãƒ»ãƒªã‚ºãƒ æœ€é©å‹",
            .good: "ç”Ÿæ´»ãƒªã‚ºãƒ ã‚„ã‚„è‰¯å¥½å‹",
            .normal: "ç”Ÿæ´»ç¿’æ…£æ¨™æº–å‹",
            .needsSupport: "ç”Ÿæ´»ç¿’æ…£ã‚µãƒãƒ¼ãƒˆå¿…è¦å‹"
        ],
        "é‹å‹•": [
            .excellent: "é‹å‹•èƒ½åŠ›å„ªä½å‹",
            .good: "é‹å‹•èƒ½åŠ›ã‚„ã‚„å„ªä½å‹",
            .normal: "é‹å‹•èƒ½åŠ›æ¨™æº–å‹",
            .needsSupport: "é‹å‹•ã‚µãƒãƒ¼ãƒˆå¿…è¦å‹"
        ],
        "é•·å¯¿": [
            .excellent: "é•·å¯¿éºä¼å­å„ªä½å‹",
            .good: "é•·å¯¿å› å­ã‚„ã‚„å„ªä½å‹",
            .normal: "é•·å¯¿å› å­æ¨™æº–å‹",
            .needsSupport: "æŠ—è€åŒ–ã‚µãƒãƒ¼ãƒˆå¿…è¦å‹"
        ]
    ]

    // MARK: - éºä¼å­èª¬æ˜å®šç¾©

    static let descriptions: [String: [ScoreLevel: String]] = [
        "ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ": [
            .excellent: "ã‚ãªãŸã®éºä¼å­ã¯ä»£è¬ãƒ»è„‚è³ªã«é–¢é€£ã™ã‚‹SNPã§ä¿è­·çš„ãªå¤‰ç•°ãŒå¤šãè¦‹ã‚‰ã‚Œã¾ã™ã€‚åŸºç¤ä»£è¬ãŒé«˜ãã€è„‚è³ªã‚’ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«åŠ¹ç‡çš„ã«å¤‰æ›ã§ãã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚é£Ÿäº‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®åŠ¹æœãŒå‡ºã‚„ã™ã„éºä¼çš„èƒŒæ™¯ã§ã™ã€‚",
            .good: "ã‚ãªãŸã®éºä¼å­ã¯ä»£è¬ãƒ»è„‚è³ªã«é–¢é€£ã™ã‚‹SNPã§ã‚„ã‚„å„ªä½ãªå¤‰ç•°ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚é©åˆ‡ãªé£Ÿäº‹ç®¡ç†ã¨é‹å‹•ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€åŠ¹æœçš„ãªãƒ€ã‚¤ã‚¨ãƒƒãƒˆãŒæœŸå¾…ã§ãã¾ã™ã€‚",
            .normal: "ã‚ãªãŸã®éºä¼å­ã¯ä»£è¬ãƒ»è„‚è³ªã«é–¢é€£ã™ã‚‹SNPã§æ¨™æº–çš„ãªå‚¾å‘ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸé£Ÿäº‹ã¨é©åº¦ãªé‹å‹•ã§ã€å¥åº·çš„ãªä½“é‡ç®¡ç†ãŒå¯èƒ½ã§ã™ã€‚",
            .needsSupport: "ã‚ãªãŸã®éºä¼å­ã¯ä»£è¬ãƒ»è„‚è³ªã«é–¢é€£ã™ã‚‹SNPã§ãƒªã‚¹ã‚¯å¤‰ç•°ãŒã‚„ã‚„å¤šãè¦‹ã‚‰ã‚Œã¾ã™ã€‚è„‚è³ªã®è“„ç©ã‚„è¡€ç³–å€¤ã®ç®¡ç†ã«æ³¨æ„ãŒå¿…è¦ãªå‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚é©åˆ‡ãªé£Ÿäº‹ç®¡ç†ã¨é‹å‹•ã§ååˆ†ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å¯èƒ½ã§ã™ã€‚"
        ],
        "ç”Ÿæ´»ç¿’æ…£": [
            .excellent: "ã‚ãªãŸã®éºä¼å­ã¯ç¡çœ ãƒ»ç”Ÿä½“ãƒªã‚ºãƒ ã«é–¢é€£ã™ã‚‹SNPã§å„ªä½ãªå¤‰ç•°ãŒå¤šãè¦‹ã‚‰ã‚Œã¾ã™ã€‚æ·±ã„ç¡çœ ã‚’å–ã‚Šã‚„ã™ãã€ã‚«ãƒ•ã‚§ã‚¤ãƒ³ä»£è¬ã‚‚è‰¯å¥½ã§ã€ã‚¹ãƒˆãƒ¬ã‚¹ã‹ã‚‰ã®å›å¾©åŠ›ã‚‚é«˜ã„éºä¼çš„èƒŒæ™¯ã‚’æŒã£ã¦ã„ã¾ã™ã€‚",
            .good: "ã‚ãªãŸã®éºä¼å­ã¯ç¡çœ ãƒ»ç”Ÿä½“ãƒªã‚ºãƒ ã«é–¢é€£ã™ã‚‹SNPã§ã‚„ã‚„å„ªä½ãªå‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚è¦å‰‡æ­£ã—ã„ç”Ÿæ´»ãƒªã‚ºãƒ ã‚’ç¶­æŒã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šè‰¯ã„ç¡çœ ã®è³ªã‚’ä¿ã¦ã¾ã™ã€‚",
            .normal: "ã‚ãªãŸã®éºä¼å­ã¯ç¡çœ ãƒ»ç”Ÿä½“ãƒªã‚ºãƒ ã«é–¢é€£ã™ã‚‹SNPã§æ¨™æº–çš„ãªå‚¾å‘ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚è¦å‰‡æ­£ã—ã„ç¡çœ ç¿’æ…£ã‚’å¿ƒãŒã‘ã‚‹ã“ã¨ã§ã€å¥åº·çš„ãªç”Ÿæ´»ãƒªã‚ºãƒ ã‚’ç¶­æŒã§ãã¾ã™ã€‚",
            .needsSupport: "ã‚ãªãŸã®éºä¼å­ã¯ç¡çœ ãƒ»ç”Ÿä½“ãƒªã‚ºãƒ ã«é–¢é€£ã™ã‚‹SNPã§ãƒªã‚¹ã‚¯å¤‰ç•°ãŒã‚„ã‚„å¤šãè¦‹ã‚‰ã‚Œã¾ã™ã€‚ç¡çœ ã®è³ªã‚„æ¦‚æ—¥ãƒªã‚ºãƒ ã®ç¶­æŒã«æ„è­˜çš„ãªã‚±ã‚¢ãŒåŠ¹æœçš„ã§ã™ã€‚è¦å‰‡æ­£ã—ã„ç”Ÿæ´»ç¿’æ…£ã§å¤§ããæ”¹å–„ã§ãã¾ã™ã€‚"
        ],
        "é‹å‹•": [
            .excellent: "ã‚ãªãŸã®éºä¼å­ã¯ç­‹è‚‰ãƒ»é‹å‹•èƒ½åŠ›ã«é–¢é€£ã™ã‚‹SNPã§å„ªä½ãªå¤‰ç•°ãŒå¤šãè¦‹ã‚‰ã‚Œã¾ã™ã€‚ç­‹ãƒˆãƒ¬ã«å¯¾ã™ã‚‹åå¿œãŒè‰¯ãã€ç­‹è‚¥å¤§ã—ã‚„ã™ã„éºä¼çš„èƒŒæ™¯ã§ã™ã€‚é©åˆ‡ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§åŠ¹ç‡çš„ã«ç­‹åŠ›ã‚¢ãƒƒãƒ—ãŒæœŸå¾…ã§ãã¾ã™ã€‚",
            .good: "ã‚ãªãŸã®éºä¼å­ã¯ç­‹è‚‰ãƒ»é‹å‹•èƒ½åŠ›ã«é–¢é€£ã™ã‚‹SNPã§ã‚„ã‚„å„ªä½ãªå‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚ç¶™ç¶šçš„ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ç€å®Ÿã«é‹å‹•èƒ½åŠ›ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚",
            .normal: "ã‚ãªãŸã®éºä¼å­ã¯ç­‹è‚‰ãƒ»é‹å‹•èƒ½åŠ›ã«é–¢é€£ã™ã‚‹SNPã§æ¨™æº–çš„ãªå‚¾å‘ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã€å¥åº·çš„ãªç­‹åŠ›ç¶­æŒãŒå¯èƒ½ã§ã™ã€‚",
            .needsSupport: "ã‚ãªãŸã®éºä¼å­ã¯ç­‹è‚‰ãƒ»é‹å‹•èƒ½åŠ›ã«é–¢é€£ã™ã‚‹SNPã§ãƒªã‚¹ã‚¯å¤‰ç•°ãŒã‚„ã‚„å¤šãè¦‹ã‚‰ã‚Œã¾ã™ã€‚ç­‹è‚‰ã®ç™ºé”ã«æ™‚é–“ãŒã‹ã‹ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ãŒã€ç¶™ç¶šçš„ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨é©åˆ‡ãªæ „é¤Šæ‘‚å–ã§ååˆ†ã«æˆæœãŒå‡ºã›ã¾ã™ã€‚"
        ],
        "é•·å¯¿": [
            .excellent: "ã‚ãªãŸã®éºä¼å­ã¯é•·å¯¿ãƒ»æŠ—è€åŒ–ã«é–¢é€£ã™ã‚‹SNPã§ä¿è­·çš„ãªå¤‰ç•°ãŒå¤šãè¦‹ã‚‰ã‚Œã¾ã™ã€‚ãƒ†ãƒ­ãƒ¡ã‚¢ã®é•·ã•ã‚„æŠ—é…¸åŒ–åŠ›ã«å„ªã‚ŒãŸéºä¼çš„èƒŒæ™¯ã‚’æŒã¡ã€ç´°èƒã®è€åŒ–ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒç·©ã‚„ã‹ãªå‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚",
            .good: "ã‚ãªãŸã®éºä¼å­ã¯é•·å¯¿ãƒ»æŠ—è€åŒ–ã«é–¢é€£ã™ã‚‹SNPã§ã‚„ã‚„å„ªä½ãªå‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚å¥åº·çš„ãªç”Ÿæ´»ç¿’æ…£ã‚’ç¶­æŒã™ã‚‹ã“ã¨ã§ã€ãã®éºä¼çš„åˆ©ç‚¹ã‚’æœ€å¤§é™ã«æ´»ã‹ã›ã¾ã™ã€‚",
            .normal: "ã‚ãªãŸã®éºä¼å­ã¯é•·å¯¿ãƒ»æŠ—è€åŒ–ã«é–¢é€£ã™ã‚‹SNPã§æ¨™æº–çš„ãªå‚¾å‘ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸé£Ÿäº‹ã¨é©åº¦ãªé‹å‹•ã§ã€å¥åº·å¯¿å‘½ã‚’å»¶ã°ã™ã“ã¨ãŒã§ãã¾ã™ã€‚",
            .needsSupport: "ã‚ãªãŸã®éºä¼å­ã¯é•·å¯¿ãƒ»æŠ—è€åŒ–ã«é–¢é€£ã™ã‚‹SNPã§ãƒªã‚¹ã‚¯å¤‰ç•°ãŒã‚„ã‚„å¤šãè¦‹ã‚‰ã‚Œã¾ã™ã€‚æŠ—é…¸åŒ–ç‰©è³ªã®æ‘‚å–ã‚„ç‚ç—‡ã‚’æŠ‘ãˆã‚‹ç”Ÿæ´»ç¿’æ…£ãŒç‰¹ã«åŠ¹æœçš„ã§ã™ã€‚æ—¥ã€…ã®ã‚±ã‚¢ã§ç´°èƒã®å¥åº·ã‚’ç¶­æŒã§ãã¾ã™ã€‚"
        ]
    ]

    // MARK: - ãƒãƒ£ãƒƒãƒˆç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆéºä¼å­ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ¤œå‡ºï¼‰

    /// ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ â†’ é–¢é€£å°ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    static let keywordToSubcategories: [String: [String]] = [
        // ãƒ€ã‚¤ã‚¨ãƒƒãƒˆãƒ»æ „é¤Šé–¢é€£
        "ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ": ["åŸºç¤ä»£è¬", "å†…è‡“è„‚è‚ª", "é£Ÿæ¬²ã®èª¿ç¯€åŠ›ï¼ˆãƒ¬ãƒ—ãƒãƒ³å€¤ï¼‰", "ã‚¤ãƒ³ã‚¹ãƒªãƒ³æŠµæŠ—æ€§", "ä¸­æ€§è„‚è‚ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰"],
        "ç—©ã›": ["åŸºç¤ä»£è¬", "å†…è‡“è„‚è‚ª", "è„‚è³ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰", "ã‚¤ãƒ³ã‚¹ãƒªãƒ³æŠµæŠ—æ€§"],
        "ä½“é‡": ["åŸºç¤ä»£è¬", "é™¤è„‚è‚ªä½“é‡", "å†…è‡“è„‚è‚ª"],
        "è„‚è‚ª": ["å†…è‡“è„‚è‚ª", "ä¸­æ€§è„‚è‚ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰", "è„‚è³ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰"],
        "ç³–è³ª": ["ã‚¤ãƒ³ã‚¹ãƒªãƒ³æŠµæŠ—æ€§", "ä¸­æ€§è„‚è‚ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰"],
        "é£Ÿäº‹": ["ã‚¤ãƒ³ã‚¹ãƒªãƒ³æŠµæŠ—æ€§", "ä¸­æ€§è„‚è‚ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰", "è„‚è³ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰"],
        "ã‚«ãƒ­ãƒªãƒ¼": ["åŸºç¤ä»£è¬", "å†…è‡“è„‚è‚ª"],
        "kcal": ["åŸºç¤ä»£è¬", "å†…è‡“è„‚è‚ª"],
        "PFC": ["é«˜ãŸã‚“ã±ããƒ€ã‚¤ã‚¨ãƒƒãƒˆåŠ¹æœ", "é«˜è„‚è‚ªãƒ€ã‚¤ã‚¨ãƒƒãƒˆåŠ¹æœ", "è„‚è³ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰"],
        "ã‚¿ãƒ³ãƒ‘ã‚¯": ["é«˜ãŸã‚“ã±ããƒ€ã‚¤ã‚¨ãƒƒãƒˆåŠ¹æœ", "ç­‹è‚‰ã®ç™ºé”"],
        "ãŸã‚“ã±ã": ["é«˜ãŸã‚“ã±ããƒ€ã‚¤ã‚¨ãƒƒãƒˆåŠ¹æœ", "ç­‹è‚‰ã®ç™ºé”"],
        "æ „é¤Š": ["åŸºç¤ä»£è¬", "è„‚è³ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰"],
        "ã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«": ["LDLã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«ï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰", "HDLã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«ï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰", "è„‚è³ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰"],

        // é‹å‹•é–¢é€£
        "ç­‹ãƒˆãƒ¬": ["ç­‹è‚‰ã®ç™ºé”", "ç­‹æŒä¹…åŠ›", "ç¬ç™ºåŠ›"],
        "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°": ["ç­‹è‚‰ã®ç™ºé”", "ç­‹æŒä¹…åŠ›", "ç¬ç™ºåŠ›"],
        "é‹å‹•": ["ç­‹è‚‰ã®ç™ºé”", "ç­‹æŒä¹…åŠ›", "ç¬ç™ºåŠ›"],
        "ç­‹è‚‰": ["ç­‹è‚‰ã®ç™ºé”", "ç­‹æŒä¹…åŠ›", "é™¤è„‚è‚ªä½“é‡"],
        "æŒä¹…åŠ›": ["ç­‹æŒä¹…åŠ›"],
        "ç¬ç™º": ["ç¬ç™ºåŠ›"],

        // ç¡çœ ãƒ»ç”Ÿæ´»ç¿’æ…£é–¢é€£
        "ç¡çœ ": ["çœ ã‚Šã®æ·±ã•", "å…¥çœ æ½œæ™‚", "æ¦‚æ—¥ãƒªã‚ºãƒ ", "æ˜¼é–“ã®çœ æ°—"],
        "çœ ": ["çœ ã‚Šã®æ·±ã•", "å…¥çœ æ½œæ™‚", "æ˜¼é–“ã®çœ æ°—"],
        "ä¸çœ ": ["å…¥çœ æ½œæ™‚", "çœ ã‚Šã®æ·±ã•", "æ¦‚æ—¥ãƒªã‚ºãƒ "],
        "ã‚«ãƒ•ã‚§ã‚¤ãƒ³": ["ã‚«ãƒ•ã‚§ã‚¤ãƒ³ä»£è¬"],
        "ã‚³ãƒ¼ãƒ’ãƒ¼": ["ã‚«ãƒ•ã‚§ã‚¤ãƒ³ä»£è¬"],
        "ã‚¹ãƒˆãƒ¬ã‚¹": ["ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ï¼ˆç²¾ç¥çš„å›å¾©åŠ›ï¼‰", "æ¦‚æ—¥ãƒªã‚ºãƒ "],
        "ãƒ¡ãƒ³ã‚¿ãƒ«": ["ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ï¼ˆç²¾ç¥çš„å›å¾©åŠ›ï¼‰"],

        // é•·å¯¿ãƒ»å¥åº·é–¢é€£
        "é•·å¯¿": ["ãƒ†ãƒ­ãƒ¡ã‚¢ã®é•·ã•ï¼ˆç´°èƒè€åŒ–ã®æŒ‡æ¨™ï¼‰", "90æ­³ä»¥ä¸Šã¾ã§ç”Ÿãã‚‹å¯èƒ½æ€§", "æŠ—é…¸åŒ–åŠ›"],
        "è€åŒ–": ["ãƒ†ãƒ­ãƒ¡ã‚¢ã®é•·ã•ï¼ˆç´°èƒè€åŒ–ã®æŒ‡æ¨™ï¼‰", "æŠ—é…¸åŒ–åŠ›"],
        "ã‚¢ãƒ³ãƒã‚¨ã‚¤ã‚¸ãƒ³ã‚°": ["ãƒ†ãƒ­ãƒ¡ã‚¢ã®é•·ã•ï¼ˆç´°èƒè€åŒ–ã®æŒ‡æ¨™ï¼‰", "æŠ—é…¸åŒ–åŠ›", "90æ­³ä»¥ä¸Šã¾ã§ç”Ÿãã‚‹å¯èƒ½æ€§"],
        "å…ç–«": ["hsCRPå€¤ (å…ç–«ç³»ç–¾æ‚£ã®æŒ‡æ¨™ï¼‰", "IL-18å€¤ (å…ç–«ç³»ç–¾æ‚£ã®æŒ‡æ¨™ï¼‰", "è£œä½“C3/C4å€¤ (å…ç–«ç³»ç–¾æ‚£ã®æŒ‡æ¨™ï¼‰"],
        "ç‚ç—‡": ["hsCRPå€¤ (å…ç–«ç³»ç–¾æ‚£ã®æŒ‡æ¨™ï¼‰", "IL-18å€¤ (å…ç–«ç³»ç–¾æ‚£ã®æŒ‡æ¨™ï¼‰"],
    ]

    /// é¡ç¾©èªè¾æ›¸ï¼ˆé¡ç¾©èª â†’ æ­£è¦å½¢ï¼‰
    static let synonyms: [String: String] = [
        "ç—©ã›ãŸã„": "ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ",
        "æ¸›é‡": "ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ",
        "ä½“é‡æ¸›": "ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ",
        "è„‚è‚ªç‡ƒç„¼": "ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ",
        "ç­‹åŠ›ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°": "ç­‹ãƒˆãƒ¬",
        "ã‚¦ã‚§ã‚¤ãƒˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°": "ç­‹ãƒˆãƒ¬",
        "ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆ": "é‹å‹•",
        "ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º": "é‹å‹•",
        "çœ ã‚Œãªã„": "ä¸çœ ",
        "å¯ä»˜ã‘ãªã„": "ä¸çœ ",
        "å¤œçœ ã‚Œãªã„": "ä¸çœ ",
    ]

    /// ãƒˆãƒ”ãƒƒã‚¯æ¨å®šç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    static let topicKeywords: [String: [String]] = [
        "nutrition": ["é£Ÿäº‹", "ã‚«ãƒ­ãƒªãƒ¼", "kcal", "æ „é¤Š", "PFC", "ã‚¿ãƒ³ãƒ‘ã‚¯", "è„‚è³ª", "ç‚­æ°´åŒ–ç‰©", "é£Ÿã¹", "é£²ã¿", "ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ", "ç—©ã›", "ä½“é‡"],
        "exercise": ["é‹å‹•", "ç­‹ãƒˆãƒ¬", "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°", "ã‚¸ãƒ ", "èµ°", "æ­©", "ç­‹è‚‰", "ã‚¹ãƒãƒ¼ãƒ„", "æŒä¹…åŠ›", "ç¬ç™º"],
        "lifestyle": ["ç¡çœ ", "çœ ", "ã‚¹ãƒˆãƒ¬ã‚¹", "ç”Ÿæ´»", "ç¿’æ…£", "æœ", "å¤œ", "ã‚«ãƒ•ã‚§ã‚¤ãƒ³", "ã‚³ãƒ¼ãƒ’ãƒ¼", "ãƒ¡ãƒ³ã‚¿ãƒ«"],
    ]

    /// ãƒˆãƒ”ãƒƒã‚¯ã”ã¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå°ã‚«ãƒ†ã‚´ãƒªãƒ¼
    static let topicDefaultSubcategories: [String: [String]] = [
        "nutrition": ["åŸºç¤ä»£è¬", "ã‚¤ãƒ³ã‚¹ãƒªãƒ³æŠµæŠ—æ€§", "ä¸­æ€§è„‚è‚ªï¼ˆè¡€ä¸­æ¿ƒåº¦ï¼‰", "é£Ÿæ¬²ã®èª¿ç¯€åŠ›ï¼ˆãƒ¬ãƒ—ãƒãƒ³å€¤ï¼‰", "é«˜ãŸã‚“ã±ããƒ€ã‚¤ã‚¨ãƒƒãƒˆåŠ¹æœ"],
        "exercise": ["ç­‹è‚‰ã®ç™ºé”", "ç­‹æŒä¹…åŠ›", "ç¬ç™ºåŠ›"],
        "lifestyle": ["çœ ã‚Šã®æ·±ã•", "å…¥çœ æ½œæ™‚", "æ¦‚æ—¥ãƒªã‚ºãƒ ", "ã‚«ãƒ•ã‚§ã‚¤ãƒ³ä»£è¬", "ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ï¼ˆç²¾ç¥çš„å›å¾©åŠ›ï¼‰"],
        "general_health": ["åŸºç¤ä»£è¬", "ã‚¤ãƒ³ã‚¹ãƒªãƒ³æŠµæŠ—æ€§", "çœ ã‚Šã®æ·±ã•", "æŠ—é…¸åŒ–åŠ›"],
    ]

    /// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒˆãƒ”ãƒƒã‚¯ã‚’æ¨å®š
    static func inferTopic(from message: String) -> String {
        var scores: [String: Int] = [:]
        for (topic, keywords) in topicKeywords {
            scores[topic] = keywords.filter { message.contains($0) }.count
        }

        // æœ€ã‚‚ã‚¹ã‚³ã‚¢ãŒé«˜ã„ãƒˆãƒ”ãƒƒã‚¯ã‚’è¿”ã™ï¼ˆåŒç‚¹ãªã‚‰æœ€åˆã®ã‚‚ã®ï¼‰
        if let best = scores.max(by: { $0.value < $1.value }), best.value > 0 {
            return best.key
        }
        return "general_health"
    }

    /// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒˆãƒ”ãƒƒã‚¯ã‹ã‚‰é–¢é€£å°ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å–å¾—ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼ï¼‰
    /// - Parameters:
    ///   - message: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    ///   - selectedTopic: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸãƒˆãƒ”ãƒƒã‚¯
    /// - Returns: é–¢é€£ã™ã‚‹å°ã‚«ãƒ†ã‚´ãƒªãƒ¼åã®é…åˆ—
    static func detectRelevantSubcategories(from message: String, selectedTopic: String) -> [String] {
        // 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ­£è¦åŒ–ï¼ˆé¡ç¾©èªç½®æ›ï¼‰
        var normalizedMessage = message
        for (synonym, normalized) in synonyms {
            normalizedMessage = normalizedMessage.replacingOccurrences(of: synonym, with: normalized)
        }

        // 2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒã§å°ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’åé›†
        var matchedSubcategories: Set<String> = []
        for (keyword, subcategories) in keywordToSubcategories {
            if normalizedMessage.contains(keyword) {
                matchedSubcategories.formUnion(subcategories)
            }
        }

        // 3. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒã—ãŸå ´åˆã¯ãã‚Œã‚’è¿”ã™
        if !matchedSubcategories.isEmpty {
            print("ğŸ§¬ [KeywordMatch] Matched \(matchedSubcategories.count) subcategories from message")
            return Array(matchedSubcategories)
        }

        // 4. ãƒãƒƒãƒã—ãªã„å ´åˆã€ãƒˆãƒ”ãƒƒã‚¯ã‹ã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’æ±ºå®š
        let effectiveTopic: String
        if selectedTopic == "general_health" {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒˆãƒ”ãƒƒã‚¯æœªé¸æŠ â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æ¨å®š
            effectiveTopic = inferTopic(from: message)
            print("ğŸ§¬ [TopicInfer] Inferred topic: \(effectiveTopic)")
        } else {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã‚’å°Šé‡
            effectiveTopic = selectedTopic
            print("ğŸ§¬ [TopicSelect] Using user-selected topic: \(effectiveTopic)")
        }

        // 5. ãƒˆãƒ”ãƒƒã‚¯ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå°ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿”ã™
        let defaults = topicDefaultSubcategories[effectiveTopic] ?? topicDefaultSubcategories["general_health"]!
        print("ğŸ§¬ [Default] Returning \(defaults.count) default subcategories for topic: \(effectiveTopic)")
        return defaults
    }
}
