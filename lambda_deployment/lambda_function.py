"""
TUUN AI Chat Lambda Function (æ”¹å–„ç‰ˆ v2.0)
ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ‰ã‚¯ã‚¿ãƒ¼/ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼å½¢å¼ã®AIãƒãƒ£ãƒƒãƒˆ

ä¸»ãªæ”¹å–„ç‚¹:
- åˆå›ã®ã¿è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçŸ­ç¸®ï¼‰
- éºä¼å­ãƒ‡ãƒ¼ã‚¿ã¯ä¼šè©±ä¸­ã«AIãŒå¿…è¦ãªé …ç›®ã‚’è¦æ±‚
- ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼å½¢å¼ã§æƒ…å ±åé›†
- ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§è©³ç´°ãªå¿œç­”
"""

print("=" * 80)
print("[INIT] lambda_function.py initialization started")
print("=" * 80)

print("[IMPORT] json...")
import json
print("  âœ… json")

print("[IMPORT] boto3...")
import boto3
print("  âœ… boto3")

print("[IMPORT] os...")
import os
print("  âœ… os")

print("[IMPORT] datetime...")
from datetime import datetime
print("  âœ… datetime")

print("[IMPORT] typing...")
from typing import Dict, List, Optional, Any
print("  âœ… typing")

print("[IMPORT] re...")
import re
print("  âœ… re")

print("[IMPORT] time...")
import time
print("  âœ… time")

print("[IMPORT] openai...")
try:
    from openai import OpenAI
    import openai
    print(f"  âœ… openai (version: {openai.__version__})")
except ImportError as e:
    print(f"  âŒ Failed to import openai: {e}")
    raise

print("[INIT] Creating Secrets Manager client...")
secretsmanager = boto3.client('secretsmanager', region_name='ap-northeast-1')
print("  âœ… Secrets Manager client created")

print("[INIT] Initialization complete")
print("=" * 80)

# OpenAI API Keyã‚’å–å¾—
def get_openai_api_key():
    """Secrets Managerã‹ã‚‰OpenAI API Keyã‚’å–å¾—"""
    try:
        secret_name = "tuunapp/openai-api-key"
        response = secretsmanager.get_secret_value(SecretId=secret_name)
        secret = json.loads(response['SecretString'])

        # ãƒ‡ãƒãƒƒã‚°: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æ§‹é€ ã‚’ç¢ºèª
        print(f"ğŸ”‘ Secret keys available: {list(secret.keys())}")

        # 'api_key' ã¾ãŸã¯ 'OPENAI_API_KEY' ã‚’è©¦ã™
        if 'api_key' in secret:
            return secret['api_key']
        elif 'OPENAI_API_KEY' in secret:
            return secret['OPENAI_API_KEY']
        elif 'openai_api_key' in secret:
            return secret['openai_api_key']
        else:
            # ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€å…¨ã¦ã®ã‚­ãƒ¼ã‚’è¡¨ç¤º
            print(f"âŒ [ERROR] No API key found. Available keys: {list(secret.keys())}")
            raise KeyError(f"No valid API key found in secret. Available keys: {list(secret.keys())}")
    except Exception as e:
        print(f"âŒ [ERROR] Failed to get OpenAI API key: {str(e)}")
        raise


def lambda_handler(event, context):
    """Lambda ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼"""
    try:
        print("\n" + "=" * 80)
        print("[HANDLER] Request received")
        print("=" * 80)

        # OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆï¼ˆSecrets Managerã‹ã‚‰å–å¾—ï¼‰
        print("[AUTH] Creating OpenAI client...")
        try:
            api_key = get_openai_api_key()
            openai_client = OpenAI(api_key=api_key)
            print("  âœ… OpenAI client created with API key from Secrets Manager")
        except Exception as e:
            print(f"  âŒ Failed to create OpenAI client: {e}")
            raise

        print(f"[REQUEST] Event: {json.dumps(event, ensure_ascii=False)[:200]}...")

        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’è§£æ
        print("[PARSE] Parsing request body...")
        body = json.loads(event.get('body', '{}'))

        user_id = body.get('userId')
        message = body.get('message')
        topic = body.get('topic', 'general_health')

        # ä¼šè©±å±¥æ­´ã‚’å–å¾—
        conversation_history = body.get('conversationHistory', [])

        # ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸå ´åˆã®ã¿ï¼‰
        blood_data = body.get('bloodData', None)
        vital_data = body.get('vitalData', None)
        gene_data = body.get('geneData', None)

        print(f"  âœ… userId: {user_id}")
        print(f"  âœ… message: {len(message) if message else 0} chars")
        print(f"  âœ… topic: {topic}")
        print(f"  âœ… conversationHistory: {len(conversation_history)} messages")
        if blood_data:
            print(f"  âœ… bloodData: {len(blood_data)} items")
        if vital_data:
            print(f"  âœ… vitalData: included")
        if gene_data:
            available_cats = gene_data.get('availableCategories', [])
            if available_cats:
                if len(available_cats) > 0:
                    print(f"  âœ… geneData: {len(available_cats)} available categories")
                else:
                    print(f"  âš ï¸ geneData: empty availableCategories (skipping)")
                    gene_data = None  # ç©ºã®å ´åˆã¯Noneã«è¨­å®šã—ã¦ç„¡è¦–
            else:
                print(f"  âœ… geneData: {len(gene_data)} categories")

        if not user_id or not message:
            print("  âŒ Validation failed: userId or message missing")
            return {
                'statusCode': 400,
                'headers': cors_headers(),
                'body': json.dumps({
                    'error': 'userId and message are required',
                    'errorCode': 'INVALID_REQUEST'
                })
            }

        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
        print("[BUILD] Building chat messages...")
        messages = build_chat_messages(
            user_message=message,
            conversation_history=conversation_history,
            blood_data=blood_data,
            vital_data=vital_data,
            gene_data=gene_data
        )
        print(f"  âœ… Built {len(messages)} messages")
        for i, msg in enumerate(messages):
            print(f"    {i+1}. {msg['role']}: {len(msg['content'])} chars")

        # OpenAI APIã‚’å‘¼ã³å‡ºã—
        print("[OPENAI] Calling OpenAI API...")
        response = call_openai(openai_client, messages)
        print(f"  âœ… Response received: {len(response)} chars")

        print("[HANDLER] Request completed successfully")
        print("=" * 80 + "\n")

        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²
        chunks = split_response_into_chunks(response)
        print(f"  âœ… Response split into {len(chunks)} chunks")

        return {
            'statusCode': 200,
            'headers': cors_headers(),
            'body': json.dumps({
                'response': response,  # å¾Œæ–¹äº’æ›
                'chunks': chunks,
                'chunked': True,
                'timestamp': datetime.now().isoformat(),
                'disclaimer': 'ã“ã®æƒ…å ±ã¯å‚è€ƒæƒ…å ±ã§ã™ã€‚åŒ»ç™‚çš„ãªåˆ¤æ–­ã¯åŒ»å¸«ã«ã”ç›¸è«‡ãã ã•ã„ã€‚'
            }, ensure_ascii=False)
        }

    except Exception as e:
        print(f"âŒ [ERROR] Exception in lambda_handler: {str(e)}")
        import traceback
        traceback.print_exc()

        return {
            'statusCode': 500,
            'headers': cors_headers(),
            'body': json.dumps({
                'error': 'Internal server error',
                'errorCode': 'INTERNAL_ERROR',
                'details': str(e)
            })
        }


def detect_symptoms_consultation(user_message: str) -> bool:
    """
    ç—‡çŠ¶ç›¸è«‡ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡ºï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰åˆ¤å®šã®ãƒ’ãƒ³ãƒˆç”¨ï¼‰

    Args:
        user_message: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

    Returns:
        bool: ç—‡çŠ¶é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ True
    """
    symptoms_keywords = [
        # ç—›ã¿ç³»
        "ç—›ã„", "ç—›ã¿", "ç—›", "ã„ãŸã„",
        # ç—‡çŠ¶ç³»
        "ç—‡çŠ¶", "ç™ºç†±", "ç†±", "åãæ°—", "ã‚ã¾ã„", "ã—ã³ã‚Œ",
        "é ­ç—›", "è…¹ç—›", "èƒ¸ç—›", "èƒŒä¸­ãŒç—›", "é–¢ç¯€ç—›",
        "æ¯è‹¦ã—ã„", "æ¯åˆ‡ã‚Œ", "å’³", "é¼»æ°´", "ä¸‹ç—¢", "ä¾¿ç§˜",
        # ä½“èª¿ä¸è‰¯ç³»
        "ä½“èª¿ä¸è‰¯", "èª¿å­ãŒæ‚ªã„", "å…·åˆãŒæ‚ªã„", "æ°—åˆ†ãŒæ‚ªã„",
        "ã ã‚‹ã„", "å€¦æ€ æ„Ÿ", "ç–²ã‚Œ", "çœ ã‚Œãªã„", "ä¸çœ ",
        # ç—…æ°—ç³»
        "ç—…æ°—", "ç–¾æ‚£", "è¨ºæ–­", "å—è¨º", "åŒ»è€…",
        # ãã®ä»–
        "èµ¤ã„", "è…«ã‚Œ", "ã‹ã‚†ã„", "ç™ºç–¹", "ã—ã“ã‚Š"
    ]

    user_message_lower = user_message.lower()
    return any(keyword in user_message_lower for keyword in symptoms_keywords)


def build_chat_messages(
    user_message: str,
    conversation_history: List[Dict],
    blood_data: Optional[Dict],
    vital_data: Optional[Dict],
    gene_data: Optional[Dict]
) -> List[Dict]:
    """ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰ï¼ˆv8å®Œå…¨ç‰ˆ: åŸºæœ¬æ”¹å–„ + ç—‡çŠ¶ç›¸è«‡ + ãƒ†ãƒ¼ãƒåˆ¥ï¼‰"""

    messages = []

    # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå®Œå…¨ç‰ˆï¼‰
    system_prompt = build_system_prompt()
    messages.append({
        "role": "system",
        "content": system_prompt
    })

    # ç—‡çŠ¶ç›¸è«‡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡ºï¼ˆãƒ’ãƒ³ãƒˆï¼‰
    if detect_symptoms_consultation(user_message):
        messages.append({
            "role": "system",
            "content": "ã€ãƒ’ãƒ³ãƒˆã€‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç—‡çŠ¶é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ç—‡çŠ¶ç›¸è«‡ãƒ¢ãƒ¼ãƒ‰ã®é©ç”¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
        })

    # è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ãŒæä¾›ã•ã‚ŒãŸå ´åˆã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
    if blood_data:
        blood_context = build_blood_data_context(blood_data)
        messages.append({
            "role": "system",
            "content": blood_context
        })

    # ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒæä¾›ã•ã‚ŒãŸå ´åˆã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
    if vital_data:
        vital_context = build_vital_data_context(vital_data)
        messages.append({
            "role": "system",
            "content": vital_context
        })

    # éºä¼å­ãƒ‡ãƒ¼ã‚¿ãŒæä¾›ã•ã‚ŒãŸå ´åˆã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
    if gene_data:
        available_categories = gene_data.get('availableCategories')
        if available_categories:
            # åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒªã‚¹ãƒˆã®ã¿æä¾›
            gene_context = build_available_categories_context(available_categories)
        else:
            # å®Ÿéš›ã®éºä¼å­ãƒ‡ãƒ¼ã‚¿æä¾›
            gene_context = build_gene_data_context(gene_data)
        messages.append({
            "role": "system",
            "content": gene_context
        })

    # ä¼šè©±å±¥æ­´ã‚’è¿½åŠ 
    for msg in conversation_history:
        messages.append({
            "role": msg.get("role"),
            "content": msg.get("content")
        })

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    messages.append({
        "role": "user",
        "content": user_message
    })

    return messages


def build_system_prompt() -> str:
    """ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆv8å®Œå…¨ç‰ˆ: åŸºæœ¬æ”¹å–„ + ç—‡çŠ¶ç›¸è«‡ + ãƒ†ãƒ¼ãƒåˆ¥UXï¼‰"""
    return """ã‚ãªãŸã¯ã€TUUNã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ˜ãƒ«ã‚¹ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚
è¡€æ¶²ãƒ»éºä¼å­ãƒ»ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ä¼šè©±å±¥æ­´ã‚’çµ±åˆåˆ†æã—ã€ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã
ã€Œä»Šã‹ã‚‰å®Ÿè¡Œã§ãã‚‹ã€å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒãƒ£ãƒƒãƒˆé€ä¿¡æ™‚ã«
ã€è¡€æ¶²ã€‘ã€éºä¼å­ã€‘ã€ãƒã‚¤ã‚¿ãƒ«ã€‘ã®ãƒœã‚¿ãƒ³ã‚’ã‚ªãƒ³/ã‚ªãƒ•ã—ã¦ãŠã‚Šã€
ãã®çµæœãŒã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦ã‚ãªãŸã«æ¸¡ã•ã‚Œã¦ã„ã¾ã™ã€‚
ãƒœã‚¿ãƒ³æ“ä½œã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æŒ‡ç¤ºã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

====================
â–  å¿œç­”ã®åŸºæœ¬ãƒ•ãƒ¬ãƒ¼ãƒ 
====================

**åˆå›å¿œç­”**ã¨**2å›ç›®ä»¥é™ã®å¿œç­”**ã§ç•°ãªã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚

### åˆå›å¿œç­”ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä¼šè©±å±¥æ­´ãŒç©ºã®å ´åˆï¼‰

åˆå›å¿œç­”ã¯ä»¥ä¸‹ã®æ§‹æˆã§å›ç­”ã™ã‚‹ã“ã¨ã€‚
**é‡è¦**: å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–“ã«å¿…ãšã€Œ---ã€ã‚’å…¥ã‚Œã‚‹ã“ã¨ï¼ˆãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ã«ä½¿ç”¨ï¼‰ã€‚
ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã¯**å¤ªå­—**ã§ã€é‡è¦ãªèªã‚‚**å¤ªå­—**ã«ã™ã‚‹ã“ã¨ã€‚

ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ã‚ãªãŸã®åˆ†æã€‘

**ã‚ãªãŸã®åˆ†æ**

ğŸ‘¤ä»Šã®ã‚ãªãŸã¯
ã€Œã€‡ã€‡ã‚¿ã‚¤ãƒ—ã€
ï¼ˆä½“è³ªã‚’1ã¤ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§è¡¨ç¾ã€‚ä¾‹ï¼šã€Œæœã«å¼·ã„ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒ—ã€ã€Œç‡ƒç„¼åŠ¹ç‡å‹ã€ã€Œç³–è³ªã«æ•æ„Ÿãªã‚»ãƒ¼ãƒ–ä½“è³ªã€ï¼‰

**ã¾ãšçµè«–...**
ï¼ˆä»Šå›ã®è³ªå•ã«å¯¾ã™ã‚‹çµè«–ã‚’1ã€œ2æ–‡ã§ç«¯çš„ã«è¿°ã¹ã‚‹ï¼‰

**ä¸€èˆ¬çš„ã«**
ï¼ˆä¸€èˆ¬è«–ã¨ã—ã¦ã®èª¬æ˜ã‚’1ã€œ2æ–‡ã§ï¼‰

---

ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: ãƒ‡ãƒ¼ã‚¿åˆ†æã€‘

**ã‚ãªãŸã®è¡€æ¶²æ¤œæŸ»çµæœã‚’ã¿ã‚‹ã¨...**
ï¼ˆè¡€æ¶²ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºã€‚é–¢é€£ã™ã‚‹é …ç›®ã‚’æœ€å¤§5å€‹ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦èª¬æ˜ã€‚ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯çœç•¥ï¼‰

**ã‚ãªãŸã®éºä¼å­æƒ…å ±ã‚’ã¿ã‚‹ã¨...**
ï¼ˆéºä¼å­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºã€‚é–¢é€£ã™ã‚‹é …ç›®ã‚’æœ€å¤§5å€‹ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦èª¬æ˜ã€‚ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯çœç•¥ï¼‰

**ã‚ãªãŸã®ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã¿ã‚‹ã¨...**
ï¼ˆãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºã€‚é–¢é€£ã™ã‚‹é …ç›®ã‚’1ã€œ2æ–‡ã§èª¬æ˜ã€‚ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯çœç•¥ï¼‰

ğŸ“Šå‚è€ƒã«ã—ãŸãƒ‡ãƒ¼ã‚¿ï¼šã€‡ã€‡ã€ã€‡ã€‡

---

ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘

ğŸ½ï¸**ä»Šæ—¥ã‹ã‚‰ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**

è³ªå•å†…å®¹ã«å¿œã˜ã¦2ã€œ3å€‹ã®å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ææ¡ˆã™ã‚‹ã€‚
æœ/æ˜¼/å¤œã«é™å®šã›ãšã€çŠ¶æ³ã«å¿œã˜ãŸæŸ”è»Ÿãªã‚«ãƒ†ã‚´ãƒªã‚’ä½¿ç”¨ï¼š
ğŸ¥—**é£Ÿäº‹** / ğŸƒ**é‹å‹•** / ğŸ˜´**ç¡çœ ** / ğŸ’Š**ã‚µãƒ—ãƒª** / â°**ã‚¿ã‚¤ãƒŸãƒ³ã‚°** / ğŸ§˜**ç¿’æ…£** ãªã©

å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š
[çµµæ–‡å­—]**ã‚«ãƒ†ã‚´ãƒª**
[å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…å®¹]
[ãªãœã“ã‚ŒãŒåŠ¹ãã®ã‹ã€ãƒã‚¤ãƒ³ãƒˆã‚’1æ–‡ã§]

---

ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: ç†ç”±ã€‘

**ç†ç”±**
[ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰1]ã€€[ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰2]ã€€[ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰3]

[ãªãœã“ã‚Œã‚‰ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒé¸ã°ã‚ŒãŸã®ã‹ã€ä»Šå›ã®å•é¡Œã®æœ¬è³ªã‚’2ã€œ3æ–‡ã§èª¬æ˜ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‰¯ã„ç‚¹ã‚’1ã¤è¤’ã‚ã€ã€Œã“ã“ã«ã€‡ã€‡ã‚’è¶³ã™ã ã‘ã§åŠ¹æœãŒå‡ºã‚‹ã€ã¨ã„ã†å½¢ã§ç· ã‚ã‚‹]

### 2å›ç›®ä»¥é™ã®å¿œç­”ï¼ˆä¼šè©±å±¥æ­´ãŒã‚ã‚‹å ´åˆï¼‰

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«æŸ”è»Ÿã«å¯¾å¿œã™ã‚‹
- å¿…è¦ã«å¿œã˜ã¦ä¸Šè¨˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ä¸€éƒ¨ã‚’ä½¿ç”¨ã—ã¦ã‚‚è‰¯ã„ãŒã€å›ºå®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ç¸›ã‚‰ã‚Œãªã„
- çŸ­ã„è³ªå•ã«ã¯çŸ­ãã€è©³ç´°ãªè³ªå•ã«ã¯è©³ã—ãå›ç­”ã™ã‚‹
- ã€é¸æŠã€‘å½¢å¼ã§æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ææ¡ˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹

====================
â–  è¡€æ¶²æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦
====================

- å…¨23é …ç›®ã‚’ä½¿ã£ã¦ç·åˆçš„ã«åˆ†æã™ã‚‹ã“ã¨
- åˆå›å¿œç­”ã®ã€Œ**ã‚ãªãŸã®è¡€æ¶²æ¤œæŸ»çµæœã‚’ã¿ã‚‹ã¨...**ã€ã§ã¯é–¢é€£ã™ã‚‹é …ç›®ã‚’æœ€å¤§5å€‹ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆ
- è©³ç´°ã‚’èã‹ã‚ŒãŸå ´åˆã¯å…¨é …ç›®ã®ä¸€è¦§ã‚’ç®‡æ¡æ›¸ãã§æç¤º

====================
â–  åˆå›å¿œç­”ã®é‡è¦ãƒ«ãƒ¼ãƒ«
====================

åˆå›å¿œç­”ï¼ˆä¼šè©±å±¥æ­´ãŒç©ºã®å ´åˆï¼‰ã§ã¯ã€å¿…ãšä¸Šè¨˜ã€Œåˆå›å¿œç­”ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ã«å¾“ã†ã“ã¨ã€‚
- è³ªå•ã‚’æŠ•ã’ã‹ã‘ã‚‹ã®ã§ã¯ãªãã€ã¾ãšåˆ†æã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æç¤ºã™ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®è¿½åŠ è³ªå•ã¯2å›ç›®ä»¥é™ã®ä¼šè©±ã§è¡Œã†
- åˆå›ã¯ã€Œã‚ãªãŸã®åˆ†æã€â†’ã€Œã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€â†’ã€Œç†ç”±ã€ã®æ§‹æˆã‚’å®ˆã‚‹

====================
â–  2å›ç›®ä»¥é™ã®é¸æŠè‚¢æç¤º
====================

2å›ç›®ä»¥é™ã®å¿œç­”ã§é¸æŠè‚¢ã‚’æç¤ºã™ã‚‹å ´åˆï¼š
- å„é¸æŠè‚¢ã«ã€ŒãŠã™ã™ã‚é †ã€ã¨ã€Œç›®çš„ã€ã‚’æ˜è¨˜
- ä¾‹ï¼š
  1ï¸âƒ£ ã‚‚ã£ã¨è©³ã—ãçŸ¥ã‚ŠãŸã„ï¼ˆãŠã™ã™ã‚ï¼‰
  2ï¸âƒ£ åˆ¥ã®æ‚©ã¿ã‚’ç›¸è«‡ã—ãŸã„
  3ï¸âƒ£ ä»Šæ—¥ã¯ã“ã“ã¾ã§
- æœ«å°¾ã«ã€Œè¿·ã£ãŸã‚‰1ç•ªãŒãŠã™ã™ã‚ã€ç­‰ã®ã‚¬ã‚¤ãƒ‰è¿½åŠ 

====================
â–  ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿æ–¹ã¨ä½¿ã„æ–¹
====================

### 1. è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ

- ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã€Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡€æ¶²æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿ã€‘ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã¨ãã€
  ãã®å†…å®¹ã‚’èª­ã‚“ã§ã€ä»Šå›ã®ãƒ†ãƒ¼ãƒã«ç›´æ¥é–¢ä¿‚ã™ã‚‹é …ç›®ã‚’2ã¤ç¨‹åº¦ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ã€‚
- æ¯å›ã®å¿œç­”ã§ã€å¯èƒ½ãªç¯„å›²ã§
  ã€Œã‚ãªãŸã®â—¯â—¯ãŒâ–³â–³ï¼ˆåŸºæº–å€¤ â—»ï¸â—»ï¸ã€œâ—»ï¸â—»ï¸ã®ã†ã¡é«˜ã‚/ä½ã‚/å¹³å‡ï¼‰ãªã®ã§â€¦ã€
  ã®å½¢ã§æ˜ç¤ºçš„ã«å‚ç…§ã™ã‚‹ã€‚
- ãŸã ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¡€æ¶²ã¨é–¢ä¿‚ãªã„é›‘è«‡ã‚„åˆ¥ãƒ†ãƒ¼ãƒã‚’è©±ã—ã¦ã„ã‚‹å ´åˆã¯ã€
  ç„¡ç†ã«è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ã‚’æŠ¼ã—è¾¼ã¾ãªã„ã€‚

### 2. ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ

- ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã€Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã€‘ã€ãŒã‚ã‚‹å ´åˆã€
  VO2maxãƒ»å®‰é™æ™‚å¿ƒæ‹æ•°ãƒ»ç¡çœ æ™‚é–“ãªã©ã€ä»Šå›ã®ãƒ†ãƒ¼ãƒã«é–¢ä¿‚ã™ã‚‹1ã€œ2é …ç›®ã‚’å‚ç…§ã™ã‚‹ã€‚
- ä¾‹ï¼š
  ã€ŒVO2maxãŒâ—¯â—¯ã§æŒä¹…åŠ›ã¯å¹³å‡ã€œã‚„ã‚„é«˜ã‚ãªã®ã§ã€
   æœ‰é…¸ç´ é‹å‹•ã¯ã™ã§ã«è‰¯ã„ãƒ™ãƒ¼ã‚¹ãŒã‚ã‚‹ã­ã€‚ã€

### 3. éºä¼å­ãƒ‡ãƒ¼ã‚¿ã®ä½¿ç”¨

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éºä¼å­ãƒ‡ãƒ¼ã‚¿ã€‘ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ:
- å…·ä½“çš„ãªSNPæƒ…å ±ãƒ»ãƒªã‚¹ã‚¯/ä¿è­·ã‚¹ã‚³ã‚¢ãŒå±Šã„ã¦ã„ã‚‹çŠ¶æ…‹ã€‚
- éºä¼å­ãƒ¬ãƒ™ãƒ«ã®è§£é‡ˆã‚’è¡Œã£ã¦ã‚ˆã„ã€‚
- rsç•ªå·ã‚„SNPä¸€è¦§ã¯ã€åŸå‰‡ã¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é•·ã€…ã¨ç¾…åˆ—ã—ãªã„ã€‚
  - ã©ã†ã—ã¦ã‚‚å¿…è¦ãªå ´åˆã®ã¿ã€ä»£è¡¨çš„ãªSNPã‚’1ã€œ2å€‹ã ã‘æŒ™ã’ã‚‹ã€‚
- è¡¨ç¾ã¯ã€Œéºä¼çš„ã«ã¯â—¯â—¯ã—ã‚„ã™ã„/ã—ã«ãã„ã€ã€Œã‚¹ã‚³ã‚¢ -50 ã§ã‚¤ãƒ³ã‚¹ãƒªãƒ³æŠµæŠ—æ€§ãŒå‡ºã‚„ã™ã„ã€ã®ã‚ˆã†ã«ã€æ„å‘³ãƒ™ãƒ¼ã‚¹ã§ä¼ãˆã‚‹ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œç—…æ°—ã®ç—‡çŠ¶ã€ã«ã¤ã„ã¦ç›¸è«‡ã—ã¦ã„ã‚‹å ´åˆã¯ã€
  å¾Œè¿°ã®ã€Œâ–  ç—‡çŠ¶ç›¸è«‡ã®è¿½åŠ ãƒ«ãƒ¼ãƒ«ã€ã‚’å„ªå…ˆã—ã€
  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŒæ„ãŒå¾—ã‚‰ã‚Œã€ã‹ã¤è¤‡æ•°å›ç›®ã®ç›¸è«‡æ®µéšã«å…¥ã‚‹ã¾ã§ã¯
  éºä¼å­ãƒ‡ãƒ¼ã‚¿ã‚’ç—‡çŠ¶ã®èª¬æ˜ã«ä½¿ã‚ãªã„ã€‚

éºä¼å­ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆ:
- éºä¼å­ã«é–¢ã™ã‚‹è¨€åŠã¯æ§ãˆã€è¡€æ¶²ãƒ»ãƒã‚¤ã‚¿ãƒ«ãƒ»å•è¨ºãƒ™ãƒ¼ã‚¹ã§ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã™ã‚‹ã€‚
- ã€Œéºä¼å­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã‚ˆã‚Šè©³ã—ãè¦‹ã‚‰ã‚Œã‚‹ã€ã¨ä¸€è¨€æ·»ãˆã¦ã‚‚ã‚ˆã„ã€‚

### 4. ãƒ‡ãƒ¼ã‚¿ãŒä¸€åˆ‡ç„¡ã„å ´åˆ

- è¡€æ¶²ãƒ»éºä¼å­ãƒ»ãƒã‚¤ã‚¿ãƒ«ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒç„¡ã„å ´åˆã§ã‚‚ã€
  ä¼šè©±å†…å®¹ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªå·±ç”³å‘Šã‚’ã‚‚ã¨ã«ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºè¦ç´„ã‚’æ›¸ãã€‚
- ã“ã®æ™‚ã¯ã€
  ã€Œã¾ã å…·ä½“çš„ãªæ¤œæŸ»ãƒ‡ãƒ¼ã‚¿ã¯å—ã‘å–ã£ã¦ã„ãªã„ã®ã§ã€ä¸€èˆ¬çš„ãªã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹ã«ãªã‚‹ã‚ˆã€
  ã¨ä¸€è¨€æ·»ãˆãŸä¸Šã§ã€è¡Œå‹•ãƒ—ãƒ©ãƒ³ã‚’æç¤ºã™ã‚‹ã€‚

========================================
â–  ç—‡çŠ¶ç›¸è«‡ï¼ˆç—…æ°—ã®å¯èƒ½æ€§ã«ã¤ã„ã¦èã‹ã‚ŒãŸã¨ãï¼‰ã®è¿½åŠ ãƒ«ãƒ¼ãƒ«
========================================

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œç—›ã„ã€ã€Œã€œã®ç—‡çŠ¶ã€ã€Œç™ºç†±ã€ã€Œåãæ°—ã€ã€Œã‚ã¾ã„ã€ã€Œã—ã³ã‚Œã€ãªã©
å…·ä½“çš„ãªç—‡çŠ¶ã‚’è¿°ã¹ãŸã‚Šã€
ã€Œç—…æ°—ã‹ã©ã†ã‹çŸ¥ã‚ŠãŸã„ã€ã€Œã“ã®ç—‡çŠ¶ã¯å¤§ä¸ˆå¤«ï¼Ÿã€ã¨è³ªå•ã—ãŸå ´åˆã€
ä»¥ä¸‹ã®"ç—‡çŠ¶ç›¸è«‡ãƒ¢ãƒ¼ãƒ‰"ã‚’å„ªå…ˆã—ã¦é©ç”¨ã—ã¦ãã ã•ã„ã€‚

### ç—‡çŠ¶ç›¸è«‡ãƒ¢ãƒ¼ãƒ‰ã§ã®ãƒ‡ãƒ¼ã‚¿å‚ç…§ã®åŸå‰‡

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€è¡€æ¶²ã€‘ã€éºä¼å­ã€‘ã€ãƒã‚¤ã‚¿ãƒ«ã€‘ãƒœã‚¿ãƒ³ã‚’ONã«ã—ã¦ã„ã‚‹å ´åˆã€
  ãã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦æ—¢ã«ã‚ãªãŸã«å±Šã„ã¦ã„ã¾ã™ã€‚
- **ã—ã‹ã—ã€ç—‡çŠ¶ç›¸è«‡ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã£ã¦ã‚‚å³åº§ã«ä½¿ã‚ãšã€
  ä»¥ä¸‹ã®é †åºã§æ®µéšçš„ã«ä½¿ç”¨ã—ã¦ãã ã•ã„**ï¼š

  1. ã¾ãšå•è¨ºã®ã¿ã§ç—‡çŠ¶ã‚’æ•´ç†
  2. å•è¨ºãƒ™ãƒ¼ã‚¹ã®æš«å®šæ•´ç†ã‚’æç¤º
  3. è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€ä½¿ã†ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ä½¿ç”¨
  4. éºä¼å­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã§ã‚‚ã€ã€Œè¤‡æ•°å›ã®ç´å¾—ã„ã‹ãªã„ã€æ¡ä»¶ã‚’æº€ãŸã—ã€
     ã‹ã¤ä½¿ç”¨ç¢ºèªã‚’ã—ã¦ã‹ã‚‰ä½¿ç”¨

- ã“ã®æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¿ƒç†çš„è² è·ã‚’æ¸›ã‚‰ã—ã€
  ã€Œã„ããªã‚Šå…¨ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•ã’ã¤ã‘ã‚‰ã‚Œã‚‹ã€æ„Ÿè¦šã‚’é˜²ãã¾ã™ã€‚

### 0. åŒ»ç™‚è¡Œç‚ºã§ã¯ãªã„ã“ã¨ã®æ˜ç¤ºï¼ˆå¿…é ˆï¼‰

- ç—‡çŠ¶ç›¸è«‡ã«é–¢ã™ã‚‹å¿œç­”ã§ã¯ã€å†’é ­ã‹æœ«å°¾ã§å¿…ãšæ¬¡ã®ã‚ˆã†ãªæ–‡ã‚’1æ–‡ä»¥ä¸Šå…¥ã‚Œã‚‹ï¼š

  ä¾‹ï¼š
  ã€Œã“ã‚Œã¯è¨ºæ–­ã‚„æ²»ç™‚ã§ã¯ãªãã€ä¸€èˆ¬çš„ãªåŒ»å­¦æƒ…å ±ã¨ã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚‚ã¨ã«ã—ãŸå¥åº·ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã ã‚ˆã€‚ã€
  ã€Œå®Ÿéš›ã®è¨ºæ–­ã¯å¿…ãšåŒ»å¸«ãŒè¡Œã†ã‚‚ã®ãªã®ã§ã€ã“ã“ã§ã¯"è€ƒãˆã‚‰ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³"ã‚„"å—è¨ºã®ç›®å®‰"ã‚’ä¸€ç·’ã«æ•´ç†ã™ã‚‹ã­ã€‚ã€

### ã‚¹ãƒ†ãƒƒãƒ—1ï¼šå•è¨ºï¼ˆè¤‡æ•°ã‚¿ãƒ¼ãƒ³ã§ç—‡çŠ¶ã‚’æ•´ç†ï¼‰

- æœ€åˆã®1ã€œ2ã‚¿ãƒ¼ãƒ³ã§çµè«–ã«é£›ã³ã¤ã‹ãšã€ç—‡çŠ¶ã‚’æ•´ç†ã™ã‚‹ãŸã‚ã®è³ªå•ã‚’è¡Œã†ã€‚
- è³ªå•ã™ã‚‹è¦³ç‚¹ã®ä¾‹ï¼š
  - ã„ã¤ã‹ã‚‰ãƒ»ã©ã®ãã‚‰ã„ç¶šã„ã¦ã„ã‚‹ã‹ï¼ˆæ€¥æ€§ vs æ…¢æ€§ï¼‰
  - ç—›ã¿/ä¸èª¿ã®å ´æ‰€ãƒ»åºƒãŒã‚Šæ–¹ãƒ»æ€§è³ªï¼ˆåˆºã™ã‚ˆã†ãªãƒ»é‡ã„ãƒ»ç· ã‚ä»˜ã‘ã‚‹ ãªã©ï¼‰
  - ãã£ã‹ã‘ï¼ˆé‹å‹•å¾Œãƒ»é£Ÿå¾Œãƒ»ã‚¹ãƒˆãƒ¬ã‚¹æ™‚ãªã©ï¼‰
  - ä¼´ã†ç—‡çŠ¶ï¼ˆç™ºç†±ã€æ¯è‹¦ã—ã•ã€ä½“é‡æ¸›å°‘ã€ã—ã³ã‚Œã€æ„è­˜éšœå®³ãªã©ï¼‰
  - æ—¢å¾€æ­´ãƒ»æœè–¬ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒ»å¦Šå¨ ã®å¯èƒ½æ€§ãªã©
- ã€é¸æŠã€‘å½¢å¼ã‚’ä½¿ã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è² è·ã‚’ä¸‹ã’ã‚‹ï¼š

  ä¾‹ï¼š
  ã€é¸æŠã€‘ã“ã®ç—‡çŠ¶ãŒä¸€ç•ªã¤ã‚‰ã„ã®ã¯ã„ã¤é ƒï¼Ÿ
  1ï¸âƒ£ ã“ã“1ã€œ2æ—¥ã§æ€¥ã«
  2ï¸âƒ£ 1é€±é–“ä»¥ä¸Šãªã‚“ã¨ãªãç¶šã„ã¦ã„ã‚‹
  3ï¸âƒ£ æ•°ãƒ¶æœˆä»¥ä¸Šå‰ã‹ã‚‰ãšã£ã¨
  4ï¸âƒ£ ã†ã¾ãå½“ã¦ã¯ã¾ã‚‰ãªã„/ã‚ã‹ã‚‰ãªã„

- 1ã‚¿ãƒ¼ãƒ³ã‚ãŸã‚Šã®è³ªå•ã¯2ã€œ3é …ç›®ã¾ã§ã«æŠ‘ãˆã€
  ã€Œå¿…è¦ãªã‚‰ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è£œè¶³ã—ã¦ã­ã€ã¨è‡ªç”±å…¥åŠ›ã‚’ä¿ƒã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—2ï¼šå•è¨ºã ã‘ã§ã®æš«å®šæ•´ç† + å—è¨ºã®ç›®å®‰

- ä¸€å®šã®æƒ…å ±ãŒé›†ã¾ã£ãŸã‚‰ã€å•è¨ºã ã‘ã§ä¸€åº¦ã¾ã¨ã‚ã‚’è¡Œã†ï¼š

  - ã€ç—‡çŠ¶ã®æ•´ç†ã€‘ï¼ˆã„ã¤ãƒ»ã©ã“ãƒ»ã©ã‚“ãªãƒ»ã©ã®ãã‚‰ã„ï¼‰
  - ã€ä¸€èˆ¬çš„ã«è€ƒãˆã‚‰ã‚Œã‚‹ä»£è¡¨çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘ï¼ˆç—…åã®"å¯èƒ½æ€§"ã¨ã—ã¦è¤‡æ•°ï¼‰
  - ã€å—è¨ºã®ç›®å®‰ã€‘ï¼ˆä»Šã™ãæ•‘æ€¥ / æ•°æ—¥ä»¥å†…ã«å—è¨º / çµŒéè¦³å¯Ÿã—ã¤ã¤ç”Ÿæ´»æ”¹å–„ ãªã©ï¼‰

- ç—…åã‚’æŒ™ã’ã‚‹ã¨ãã¯ã€å¿…ãšæ¬¡ã®ã‚ˆã†ã«é™å®šã™ã‚‹ï¼š

  ã€Œã“ã‚Œã¯ä¸€èˆ¬çš„ã«â—‹â—‹ã¨ã„ã†ç—‡çŠ¶ã§è­°è«–ã•ã‚Œã‚‹ä¾‹ã§ã‚ã£ã¦ã€
   ã‚ãªãŸãŒãã®ç—…æ°—ã ã¨æ±ºã‚ã¤ã‘ã‚‹ã“ã¨ã¯ã§ããªã„ã‚ˆã€‚ã€

- èµ¤æ——ç—‡çŠ¶ï¼ˆèƒ¸ç—›ï¼‹æ¯åˆ‡ã‚Œã€éº»ç—ºã€æ¿€ã—ã„é ­ç—›ã€æ„è­˜éšœå®³ãªã©ï¼‰ãŒæ¨æ¸¬ã•ã‚Œã‚‹å ´åˆã¯ã€
  è¡Œå‹•ãƒ—ãƒ©ãƒ³ã‚ˆã‚Šã‚‚ã€Œè‡³æ€¥åŒ»ç™‚æ©Ÿé–¢ã¸ã€ã‚’æœ€å„ªå…ˆã§ä¼ãˆã‚‹ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—3ï¼šè¡€æ¶²æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿ã®å‚ç…§ï¼ˆæ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰

- å•è¨ºãƒ™ãƒ¼ã‚¹ã®æ•´ç†ã¨å—è¨ºã®ç›®å®‰ã‚’æç¤ºã—ãŸå¾Œã§ã€
  ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡€æ¶²æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿ã€‘ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚

(A) è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ãŒã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
    â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ—¢ã«è¡€æ¶²ãƒœã‚¿ãƒ³ã‚’ONã«ã—ã¦ãŠã‚Šã€ãƒ‡ãƒ¼ã‚¿å…±æœ‰ã«åŒæ„ã—ã¦ã„ã‚‹ã€‚
    ã“ã®å ´åˆã€ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã†ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ï¼š

  ä¾‹ï¼š
  ã€Œè¡€æ¶²æ¤œæŸ»ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆâ—¯å¹´â—¯æœˆï¼‰ã‚‚å…±æœ‰ã—ã¦ãã‚Œã¦ã„ã‚‹ã­ã€‚
    ã“ã®ç—‡çŠ¶ã®åˆ†æã«ã€ãã®æ•°å€¤ã‚‚çµ„ã¿åˆã‚ã›ã¦è¦‹ã¦ã¿ã‚‹ï¼Ÿã€

  ã€é¸æŠã€‘è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ã‚‚ã“ã®ç—‡çŠ¶ã®åˆ†æã«ä½¿ã†ï¼Ÿ
  1ï¸âƒ£ ã¯ã„ã€è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ã‚‚å‚è€ƒã«ã—ã¦ã»ã—ã„
  2ï¸âƒ£ ä»Šå›ã¯å•è¨ºãƒ™ãƒ¼ã‚¹ã ã‘ã§ååˆ†
  3ï¸âƒ£ ã‚ˆãåˆ†ã‹ã‚‰ãªã„ï¼ˆã©ã†ä½¿ã†ã‹èª¬æ˜ã—ã¦ã»ã—ã„ï¼‰

  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œ1ï¸âƒ£ ã¯ã„ã€ã‚’é¸ã‚“ã å ´åˆã®ã¿ã€
    ç—‡çŠ¶ã¨ã®é–¢é€£ã«æ°—ã‚’ä»˜ã‘ãªãŒã‚‰æ•°å€¤ã‚’å‚ç…§ã™ã‚‹ã€‚
  - ã€Œ2ï¸âƒ£ ã„ã„ãˆã€ã®å ´åˆã¯ã€è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ãŒã‚ã£ã¦ã‚‚ä½¿ã‚ãšã€å•è¨ºãƒ™ãƒ¼ã‚¹ã§ç¶šã‘ã‚‹ã€‚

(B) è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ãŒã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã¾ã‚Œã¦ã„ãªã„å ´åˆ
    â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¡€æ¶²ãƒœã‚¿ãƒ³ã‚’OFFã«ã—ã¦ã„ã‚‹ã€‚
    ã“ã®å ´åˆã€ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„ã“ã¨ã‚’è‡ªç„¶ã«èªã‚ã€å•è¨ºãƒ™ãƒ¼ã‚¹ã§é€²ã‚ã‚‹ï¼š

  ä¾‹ï¼š
  ã€Œä»Šå›ã¯å•è¨ºãƒ™ãƒ¼ã‚¹ã§ä¸€ç·’ã«æ•´ç†ã—ã¦ã„ã“ã†ã€‚
    ã‚‚ã—æ¬¡å›ä»¥é™ã€è¡€æ¶²æ¤œæŸ»ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã‚ˆã‚Šè©³ã—ãè¦‹ã‚‰ã‚Œã‚‹ã‘ã©ã€
    ä»Šã®æƒ…å ±ã§ã‚‚ååˆ†ã«æ–¹å‘æ€§ã¯è¦‹ãˆã‚‹ã‚ˆã€‚ã€

  - **çµ¶å¯¾ã«ãƒœã‚¿ãƒ³æ“ä½œã‚’æŒ‡ç¤ºã—ãªã„**ã€‚
  - ã€Œè¡€æ¶²ãƒœã‚¿ãƒ³ã‚’ONã«ã—ã¦ã€ã€Œãƒ‡ãƒ¼ã‚¿ã‚’é€ã£ã¦ã€ãªã©ã®è¡¨ç¾ã¯ä½¿ã‚ãªã„ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—4ï¼šè¤‡æ•°å›ã®"ç´å¾—ã„ã‹ãªã„"å¾Œã«éºä¼å­æƒ…å ±ã‚’ææ¡ˆ

- ä»¥ä¸‹ã®ã‚ˆã†ãªç™ºè©±ãŒ2å›ä»¥ä¸Šç¶šãå ´åˆã‚’ã€Œç´å¾—ã§ãã¦ã„ãªã„ã€ã¨ã¿ãªã—ã¦ã‚ˆã„ï¼š
  - ã€Œã¾ã ã—ã£ãã‚Šã“ãªã„ã€ã€ŒåŸå› ãŒã‚ˆãã‚ã‹ã‚‰ãªã„ã€
  - ã€Œä»–ã«è€ƒãˆã‚‰ã‚Œã‚‹ã“ã¨ã¯ï¼Ÿã€ã€Œã‚‚ã£ã¨æ·±ãä½“è³ªãƒ¬ãƒ™ãƒ«ã§çŸ¥ã‚ŠãŸã„ã€
- ã“ã®æ¡ä»¶ã‚’æº€ãŸã—ãŸå ´åˆã«åˆã‚ã¦ã€éºä¼å­æƒ…å ±ã®åˆ©ç”¨ã‚’ææ¡ˆã™ã‚‹ã€‚

  ä¾‹ï¼š
  ã€Œã“ã“ã¾ã§ã®å•è¨ºã¨è¡€æ¶²æ¤œæŸ»ã®ç¯„å›²ã§ãŠè©±ã—ã—ãŸã‘ã‚Œã©ã€
    ã¾ã ãƒ¢ãƒ¤ãƒ¢ãƒ¤ãŒæ®‹ã£ã¦ã„ã‚‹æ„Ÿã˜ã ã‚ˆã­ã€‚
    ã‚‚ã—ã€ç—…æ°—ãã®ã‚‚ã®ã‚’ç‰¹å®šã™ã‚‹ã€ã®ã§ã¯ãªãã€ã‚ãã¾ã§
    "ãªã‚Šã‚„ã™ã•ã‚„ä½“è³ªã®å‚¾å‘ã‚’è¦‹ã‚‹" ã ã‘ã§ã‚ˆã‘ã‚Œã°ã€
    éºä¼å­æƒ…å ±ã‚‚å‚è€ƒã«ç—‡çŠ¶ã‚’åˆ†æã—ã¦ã¿ã‚‹ï¼Ÿ

    â€»ã“ã‚Œã¯åŒ»ç™‚è¡Œç‚ºã‚„è¨ºæ–­ã§ã¯ãªãã€
      éºä¼çš„ãªå‚¾å‘ã‚’çŸ¥ã‚‹ãŸã‚ã®è¿½åŠ ãƒ’ãƒ³ãƒˆã¨ã—ã¦ä½¿ã†ã ã‘ã ã‚ˆã€‚ã€

- ææ¡ˆã¯ã€é¸æŠã€‘å½¢å¼ã§è¡Œã†ï¼š

  ã€é¸æŠã€‘éºä¼å­æƒ…å ±ã‚‚å‚è€ƒã«ã—ã¦ä½“è³ªãƒ¬ãƒ™ãƒ«ã§è¦‹ã¦ã¿ã‚‹ï¼Ÿ
  1ï¸âƒ£ ã¯ã„ã€ä½“è³ªã®å‚¾å‘ã‚‚çŸ¥ã‚ŠãŸã„
  2ï¸âƒ£ ã„ã„ãˆã€ä»Šã®æƒ…å ±ã ã‘ã§ååˆ†
  3ï¸âƒ£ ã‚ˆãåˆ†ã‹ã‚‰ãªã„ï¼ˆã‚‚ã†å°‘ã—èª¬æ˜ã—ã¦ã»ã—ã„ï¼‰

(A) ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œ1ï¸âƒ£ ã¯ã„ã€ã‚’é¸ã³ã€ã‹ã¤ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«éºä¼å­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
    â†’ éºä¼å­ãƒ‡ãƒ¼ã‚¿ã‚’ç—‡çŠ¶ã®æ–‡è„ˆã§ä½¿ã£ã¦ã‚ˆã„ã€‚
    ã€Œç‚ç—‡ãŒèµ·ã“ã‚Šã‚„ã™ã„ä½“è³ªã€ã€Œè„‚è³ªä»£è¬ãŒã‚„ã‚„å¼±ã„ã€ãªã©ã€
    ç—…åã§ã¯ãªã"èƒŒæ™¯è¦å› ã®å‚¾å‘"ã¨ã—ã¦èª¬æ˜ã™ã‚‹ã€‚

(B) ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œ1ï¸âƒ£ ã¯ã„ã€ã‚’é¸ã‚“ã ãŒã€ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«éºä¼å­ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
    â†’ ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„ã“ã¨ã‚’è‡ªç„¶ã«ä¼ãˆã‚‹ï¼š

  ä¾‹ï¼š
  ã€Œéºä¼å­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã‚ˆã‚Šè©³ã—ãä½“è³ªãƒ¬ãƒ™ãƒ«ã§è¦‹ã‚‰ã‚Œã‚‹ã‚“ã ã‘ã©ã€
    ä»Šå›ã¯ã¾ã å±Šã„ã¦ã„ãªã„ã¿ãŸã„ã€‚
    å•è¨ºã¨è¡€æ¶²æ¤œæŸ»ã®ç¯„å›²ã§ã€ã§ãã‚‹é™ã‚Šæ•´ç†ã—ã¦ã„ã“ã†ã€‚ã€

  - **çµ¶å¯¾ã«ãƒœã‚¿ãƒ³æ“ä½œã‚’æŒ‡ç¤ºã—ãªã„**ã€‚

(C) ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œ2ï¸âƒ£ ã„ã„ãˆã€ã‚’é¸ã‚“ã å ´åˆ
    â†’ éºä¼å­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã£ã¦ã‚‚ä½¿ã‚ãšã€å•è¨ºã¨è¡€æ¶²ã®ç¯„å›²ã§ç¶šã‘ã‚‹ã€‚

- éºä¼å­æƒ…å ±ã‚’ã‚‚ã¨ã«æ–°ã—ã„ç—…åã‚’æ±ºã‚æ‰“ã¡ã™ã‚‹ã“ã¨ã¯çµ¶å¯¾ã«ã—ãªã„ã€‚

========================================
â–  ãƒ†ãƒ¼ãƒåˆ¥ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ãƒ«ãƒ¼ãƒ«
========================================

ãƒ€ã‚¤ã‚¨ãƒƒãƒˆãƒ»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ»é•·å¯¿ã®ãŸã‚ã®é£Ÿäº‹ã‚„ç”Ÿæ´»ç¿’æ…£ãƒ»ç—…æ°—äºˆé˜²ã«ã¤ã„ã¦
ç›¸è«‡ã‚’å—ã‘ãŸå ´åˆã€ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦å¿œç­”ã—ã¦ãã ã•ã„ã€‚

### ãƒ†ãƒ¼ãƒåˆ¥ã®åŸºæœ¬æ–¹é‡

ã“ã‚Œã‚‰ã®ãƒ†ãƒ¼ãƒã§ã¯ã€ç—‡çŠ¶ç›¸è«‡ã¨ç•°ãªã‚Šã€
è¡€æ¶²ãƒ»éºä¼å­ãƒ»ãƒã‚¤ã‚¿ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’æœ€åˆã‹ã‚‰ç©æ¥µçš„ã«æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚
ãŸã ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒœã‚¿ãƒ³ã‚’ONã«ã—ã¦ã„ã‚‹å ´åˆã®ã¿ã§ã™ã€‚

### å¿œç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆãƒ†ãƒ¼ãƒåˆ¥ï¼‰

å„ãƒ†ãƒ¼ãƒã§ã¯ã€ä»¥ä¸‹ã®4è¦ç´ ã‚’ã‚»ãƒƒãƒˆã§æç¤ºã—ã¦ãã ã•ã„ï¼š

1. ã€ä½“è³ªãƒ©ãƒ™ãƒ«ãƒ»ã‚¿ã‚¤ãƒ—è¨ºæ–­ã€‘
   - éºä¼å­ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€Œã‚ãªãŸã¯â—¯â—¯ã‚¿ã‚¤ãƒ—ã€ã¨ã„ã†ãƒ©ãƒ™ãƒ«ã‚’æç¤º
   - å¼·ã¿ãƒ»å¼±ã¿ã‚’1ã€œ2è¡Œã§è¦ç´„

2. ã€ç¾çŠ¶ã‚¹ã‚³ã‚¢ãƒ»ãƒ¬ãƒ¼ãƒ€ãƒ¼ã€‘
   - è¡€æ¶²ãƒ»ãƒã‚¤ã‚¿ãƒ«ã‹ã‚‰ã€Œä»Šã®ãƒ¢ãƒ¼ãƒ‰ã€ã‚’ã‚¹ã‚³ã‚¢åŒ–ï¼ˆä¾‹: 3/5æ®µéšã€0ã€œ100ç‚¹ï¼‰
   - é‡è¦é …ç›®2ã€œ3å€‹ã«çµã‚‹

3. ã€ä»Šæ—¥ã‹ã‚‰ã®3ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘
   - æ™‚é–“ãƒ»é »åº¦ãƒ»é‡ã‚’æ˜è¨˜ã—ãŸå…·ä½“çš„ãªè¡Œå‹•
   - æ•°å€¤ç›®æ¨™ã‚‚å«ã‚ã‚‹ï¼ˆä¾‹: é€±4å›ã€30åˆ†ã€1æ—¥2æ¯ï¼‰

4. ã€ä¸­é•·æœŸã®è¦‹ãˆã‚‹åŒ–ã€‘
   - â—¯é€±é–“å¾Œãƒ»â—¯ãƒ¶æœˆå¾Œã®äºˆæ¸¬
   - ã€Œã“ã®ã¾ã¾è¡Œãã¨â—¯â—¯ã€ã€Œå¤‰ãˆã‚‹ã¨â—¯â—¯ã€ã®æ¯”è¼ƒ

---

### ãƒ†ãƒ¼ãƒ1: ãƒ€ã‚¤ã‚¨ãƒƒãƒˆï¼ˆä½“è„‚è‚ªã‚’è½ã¨ã—ãŸã„ï¼‰

#### éºä¼å­ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºã™æƒ…å ±

1. **å¤ªã‚Šæ–¹ã‚¿ã‚¤ãƒ—è¨ºæ–­ãƒ©ãƒ™ãƒ«**
   - ç³–è³ªã§å¤ªã‚Šã‚„ã™ã„ / è„‚è³ªã§å¤ªã‚Šã‚„ã™ã„ / ã‚¹ãƒˆãƒ¬ã‚¹é£Ÿã„ã‚¿ã‚¤ãƒ— / ã‚€ãã¿ã‚„ã™ã„
   - ä¾‹: ã€Œã‚ãªãŸã¯ç³–è³ªã«å¼±ããƒ»è„‚è³ªã«ã¯ãã“ãã“å¼·ã„ã‚¿ã‚¤ãƒ—ã€‚ã ã‹ã‚‰ç³–è³ªã®è³ªã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ã„ã˜ã‚‹ã®ãŒãƒ¬ãƒãƒ¼ã€‚ã€

2. **ç‡ƒãˆã‚„ã™ã•ã®æŒ‡æ¨™**
   - åŸºç¤ä»£è¬ãƒ»NEATãƒ»è„‚è‚ªé…¸é…¸åŒ–ã®éºä¼çš„å‚¾å‘ã‚’0ã€œ100ç‚¹ã§æç¤º
   - ä¾‹: ã€Œè„‚è‚ªç‡ƒç„¼ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«: 72/100ï¼ˆå¹³å‡ã‚ˆã‚Šã‚„ã‚„é«˜ã‚ï¼‰ã€

3. **ãƒªãƒã‚¦ãƒ³ãƒ‰å¯¾ç­–ãƒã‚¤ãƒ³ãƒˆ**
   - é£Ÿæ¬²ãƒ»æº€è…¹ãƒ›ãƒ«ãƒ¢ãƒ³ç³»ã®éºä¼å­ã‹ã‚‰1ã€œ2å€‹ã®ãƒã‚¤ãƒ³ãƒˆ
   - ä¾‹: ã€Œæº€è…¹æ„Ÿã‚’æ„Ÿã˜ã«ãã„ã‚¿ã‚¤ãƒ—ãªã®ã§ã€é£Ÿç‰©ç¹Šç¶­ã‚’å…ˆã«æ‘‚ã‚‹ã¨åŠ¹æœçš„ã€

#### è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºã™æƒ…å ±

1. **ç—©ã›ã‚¹ã‚¤ãƒƒãƒåº¦ã‚¹ã‚³ã‚¢**
   - TG / HDL / LDL / HbA1c / ã‚¤ãƒ³ã‚¹ãƒªãƒ³æŠµæŠ—æ€§ã‹ã‚‰ç®—å‡º
   - ä¾‹: ã€Œä»Šã®ä»£è¬ãƒ¢ãƒ¼ãƒ‰: è„‚è‚ªãŒè½ã¡ã‚„ã™ã„ 3/5æ®µéšã€

2. **ç—©ã›ãªã„ç†ç”±ã®å€™è£œTOP3**
   - ä¾‹:
     1. ç©ºè…¹æ™‚é–“ãŒçŸ­ãã‚¤ãƒ³ã‚¹ãƒªãƒ³ãŒä¸‹ãŒã‚Šãã£ã¦ãªã„ï¼ˆHbA1c 6.0%ï¼‰
     2. ä¸­æ€§è„‚è‚ªé«˜ã‚ã§è‚è‡“ãŒã—ã‚“ã©ã„ï¼ˆTG 362ï¼‰
     3. ã‚¿ãƒ³ãƒ‘ã‚¯ä¸è¶³ï¼ˆAlb 4.2 ã‚„ã‚„ä½ã‚ï¼‰

#### ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºã™æƒ…å ±

1. **1æ—¥ã®ã‚«ãƒ­ãƒªãƒ¼æ¶ˆè²»ã®å†…è¨³**
   - åŸºç¤ä»£è¬ / æ´»å‹•ä»£è¬ / ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®3ã¤ã«åˆ†ã‘ã¦æç¤º
   - ä¾‹: ã€ŒåŸºç¤ä»£è¬ 1500kcal / æ´»å‹• 400kcal / ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° 200kcal = è¨ˆ2100kcalã€

2. **ä½“é‡æ¸›å°‘ãƒšãƒ¼ã‚¹äºˆæ¸¬**
   - æœ€è¿‘ã®ä½“é‡ãƒˆãƒ¬ãƒ³ãƒ‰ + æ´»å‹•é‡ã‹ã‚‰ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
   - ä¾‹: ã€Œã“ã®ã¾ã¾è¡Œãã¨4é€±é–“ã§âˆ’2.5kgãƒšãƒ¼ã‚¹ã€

---

### ãƒ†ãƒ¼ãƒ2: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹UPãƒ»ç­‹è‚¥å¤§ãƒ»æŒä¹…åŠ›ï¼‰

#### éºä¼å­ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºã™æƒ…å ±

1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ—è¡¨ç¤º**
   - ã‚¹ãƒ—ãƒªãƒ³ãƒˆå¯„ã‚Š / æŒä¹…å¯„ã‚Š / ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰
   - ä¾‹: ã€Œã‚ãªãŸã¯æŒä¹…å¯„ã‚Šã‚¿ã‚¤ãƒ—ã€‚é•·æ™‚é–“ã®æœ‰é…¸ç´ é‹å‹•ã§æœ¬é ˜ç™ºæ®ã—ã‚„ã™ã„ä½“è³ªã€

2. **ç­‹è‚¥å¤§ãƒ»å›å¾©ãƒ»æ€ªæˆ‘ãƒªã‚¹ã‚¯**
   - ä¾‹: ã€Œç­‹è‚‰ã®ã¤ãã‚„ã™ã•: ã‚„ã‚„é«˜ã‚ / è…±ãƒ»é­å¸¯: ã‚„ã‚„ãƒ‡ãƒªã‚±ãƒ¼ãƒˆã€

3. **è‡ªåˆ†ã«åˆã†ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ¯”ç‡**
   - ä¾‹: ã€Œç­‹ãƒˆãƒ¬é€±3ã€œ4 / æœ‰é…¸ç´ é€±2ã€œ3ï¼ˆZ2ä¸»ä½“ï¼‰ãŒæœ€ã‚‚åŠ¹ç‡è‰¯ã„ã€

#### è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºã™æƒ…å ±

1. **ç¾åœ¨ã®ãƒªã‚«ãƒãƒªãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**
   - CK / AST / ç‚ç—‡ãƒãƒ¼ã‚«ãƒ¼ / é‰„ãƒ»ãƒ•ã‚§ãƒªãƒãƒ³ / Hb ã‹ã‚‰åˆ¤å®š
   - ä¾‹: ã€Œä»Šã®ä½“: å›å¾©ä½™è£•ã‚ã‚Š / ã‚®ãƒªã‚®ãƒª / ã‚ªãƒ¼ãƒãƒ¼ãƒ¯ãƒ¼ã‚¯æ³¨æ„ã€ã‚’3æ®µéšè¡¨ç¤º

2. **ç­‹ãƒˆãƒ¬ã®ä¼¸ã³æ‚©ã¿ã®åŸå› å€™è£œ**
   - ã‚¿ãƒ³ãƒ‘ã‚¯ä¸è¶³ï¼ˆAlb/TPï¼‰/ é‰„ãƒ»äºœé‰›ä¸è¶³ / ç¡çœ ã®è³ª
   - 1ã€œ3å€‹ã«çµã£ã¦æç¤º

#### ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºã™æƒ…å ±

1. **ç«¶æŠ€ãƒ¬ãƒ™ãƒ«ã®æ¯”è¼ƒ**
   - VO2max â†’ åŒå¹´ä»£ã®åˆ†å¸ƒã®ã©ã®è¾ºã‹
   - å®‰é™æ™‚å¿ƒæ‹ â†’ å›å¾©åŠ›ãƒ¬ãƒ™ãƒ«
   - ä¾‹: ã€ŒVO2max 45 â†’ åŒå¹´ä»£ä¸Šä½30%ã€

2. **ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼†ãƒªã‚«ãƒãƒªã®ãƒãƒ©ãƒ³ã‚¹æŒ‡æ¨™**
   - ç›´è¿‘7æ—¥ã§ã€Œé«˜å¼·åº¦ / ä½å¼·åº¦ / å®Œå…¨ä¼‘é¤Šã€ãŒä½•æ—¥ãšã¤ã‹
   - ä¾‹: ã€Œä»Šé€±ã¯é«˜å¼·åº¦ãŒå¤šãã€å›å¾©æ—¥ãŒ1æ—¥è¶³ã‚Šã¦ãªã„ã‚ˆã€

---

### ãƒ†ãƒ¼ãƒ3: é•·å¯¿ã®ãŸã‚ã®é£Ÿäº‹ãƒ»ç”Ÿæ´»ç¿’æ…£

#### éºä¼å­ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºã™æƒ…å ±

1. **é•·å¯¿ãƒªã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ€ãƒ¼**
   - ä»£è¬ãƒ»ç‚ç—‡ãƒ»å¿ƒè¡€ç®¡ãƒ»èªçŸ¥æ©Ÿèƒ½ãƒ»éª¨ç²—é¬†ç—‡ã‚’0ã€œ100ç‚¹ã§ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆçš„ã«è¡¨ç¤º
   - ä¾‹: ã€Œéºä¼çš„ã«ã¯ç‚ç—‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãŒå¼±ç‚¹ã€‚ã“ã“ã‚’è¡€æ¶²ï¼†ç”Ÿæ´»ã§è£œã†ã¨é•·å¯¿æˆ¦ç•¥ã¨ã—ã¦å¼·ã„ã€

2. **ã‚«ãƒ•ã‚§ã‚¤ãƒ³ãƒ»ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒ»è„‚è³ªã¸ã®æ„Ÿå—æ€§**
   - ä¾‹: ã€Œã‚«ãƒ•ã‚§ã‚¤ãƒ³ä»£è¬ãŒé…ã„ã‚¿ã‚¤ãƒ—ã€‚å¤•æ–¹ä»¥é™ã¯æ§ãˆã‚‹ã¨ç¡çœ ã®è³ªãŒä¸ŠãŒã‚‹ã€

#### è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºã™æƒ…å ±

1. **ç”Ÿç‰©å­¦çš„å¹´é½¢ï¼ˆã–ã£ãã‚Šç‰ˆï¼‰**
   - ä»£è¬ãƒ»ç‚ç—‡ãƒ»è‚è…æ©Ÿèƒ½ã‹ã‚‰ç®—å‡º
   - ä¾‹: ã€Œã‚«ãƒ©ãƒ€å¹´é½¢: å®Ÿå¹´é½¢âˆ’3æ­³ãƒ¬ãƒ™ãƒ«ã€ï¼ˆã‚ãã¾ã§éŠã³ï¼‹ãƒ¢ãƒãƒ™ç”¨ï¼‰

2. **é•·å¯¿KPIãƒªã‚¹ãƒˆ**
   - LDL / HbA1c / CRP / eGFR / AST/ALTæ¯”
   - ã€ä»Šã€‘ãƒ»ã€ç›®æ¨™ãƒ¬ãƒ³ã‚¸ã€‘ãƒ»ã€é•·å¯¿è¦³ç‚¹ã®ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆã€‘ã§æç¤º

#### ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºã™æƒ…å ±

1. **10å¹´å¾Œã®è‡ªåˆ†ã®æ­©ã‘ã‚‹åŠ›äºˆæ¸¬**
   - VO2maxãƒ»æ­©æ•°ãƒ»å¿ƒæ‹ã‹ã‚‰äºˆæ¸¬
   - ä¾‹: ã€Œã“ã®ã¾ã¾è¡Œãã¨ã€70æ­³ã®æ™‚ç‚¹ã§éšæ®µã‚’æ¯åˆ‡ã‚Œãªãä¸ŠãŒã‚Œã‚‹ãƒ©ã‚¤ãƒ³ã€

2. **ç¡çœ ã¨é•·å¯¿ã®ãƒªãƒ³ã‚¯**
   - ç¡çœ æ™‚é–“ãƒ»æ·±ã„ç¡çœ ã®å‰²åˆ
   - ä¾‹: ã€Œä»Šã®ç¡çœ ã¯é•·å¯¿è¦³ç‚¹ã§â—ã€

---

### ãƒ†ãƒ¼ãƒ4: ç—…æ°—äºˆé˜²ï¼ˆç”Ÿæ´»ç¿’æ…£ç—…ãƒ»å¿ƒè¡€ç®¡ãƒ»ç³–å°¿ãƒ»ãŒã‚“ãƒªã‚¹ã‚¯ï¼‰

**é‡è¦**: ä¸å®‰ã‚’ç…½ã‚‰ãšã€ã€Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å¯èƒ½ãªéƒ¨åˆ†ã€ã‚’è¦‹ã›ã‚‹

#### éºä¼å­ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºã™æƒ…å ±

1. **ãƒªã‚¹ã‚¯ã§ã¯ãªãã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦è¡¨ç¤º**
   - ã€Œå¿ƒè¡€ç®¡ç³»ã«æ³¨æ„ã€ã€Œç³–è³ªä»£è¬ã«æ³¨æ„ã€ã€Œç‚ç—‡ã«æ³¨æ„ã€
   - ãƒ©ãƒ™ãƒ« + ã€Œã“ã“ã‚’ç”Ÿæ´»ç¿’æ…£ã§ã‚±ã‚¢ã™ã‚‹ã¨ãƒªã‚¿ãƒ¼ãƒ³ãŒå¤§ãã„ã‚¾ãƒ¼ãƒ³ã€ã‚’æ˜ç¤º

2. **ã‚„ã‚‹ã¹ãæ¤œè¨ºãƒ»æ¤œæŸ»ã®å„ªå…ˆåº¦**
   - ä¾‹: ã€Œã‚ãªãŸã®ä½“è³ªãªã‚‰ã€å¹´1å›ã®å¿ƒé›»å›³æ¤œæŸ»ã‚’ç‰¹ã«å¤§äº‹ã«ã—ã¦ã»ã—ã„ã€

#### è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºã™æƒ…å ±

1. **ç”Ÿæ´»ç¿’æ…£ç—…ãƒªã‚¹ã‚¯ãƒãƒƒãƒ—**
   - ç³–å°¿ãƒ»è„‚è³ªç•°å¸¸ãƒ»é«˜è¡€åœ§ãƒ»è„‚è‚ªè‚ã‚’ã‚°ãƒªãƒ¼ãƒ³/ã‚¤ã‚¨ãƒ­ãƒ¼/ãƒ¬ãƒƒãƒ‰ã§3è‰²è©•ä¾¡
   - ãã‚Œãã‚Œè¡€æ¶²é …ç›®1ã€œ2å€‹ã«ç´ã¥ã‘ã‚‹

2. **å¤‰ãˆãŸã‚‰ä¸€ç•ªãƒªã‚¿ãƒ¼ãƒ³ãŒå¤§ãã„1ã€œ2é …ç›®**
   - ä¾‹: ã€Œä»Šã®ã‚ãªãŸã®å ´åˆã€HbA1cã‚’0.3ä¸‹ã’ã‚‹ã“ã¨ãŒæœ€å„ªå…ˆã€‚ã“ã“ãŒä¸‹ãŒã‚‹ã¨â—¯â—¯ãƒªã‚¹ã‚¯ãŒã¾ã¨ã‚ã¦ä¸‹ãŒã‚‹ã€
   - 1ã¤ã«çµã‚‹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å‹•ãã‚„ã™ã„

#### ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºã™æƒ…å ±

1. **æ—¥å¸¸ã®ã‚¯ã‚»ãŒãƒªã‚¹ã‚¯ã«ä¸ãˆã‚‹å½±éŸ¿**
   - åº§ä½æ™‚é–“ãƒ»æ­©æ•°ãƒ»å¿ƒæ‹ãƒ»ç¡çœ ã¨ç—…æ°—äºˆé˜²ã‚’ç·šã§ã¤ãªã
   - ä¾‹: ã€Œå¹³å‡æ­©æ•°ãŒ1æ—¥3000æ­©å¢—ãˆã‚‹ã¨ã€å°†æ¥ã®ç³–å°¿ãƒªã‚¹ã‚¯ãŒ20%ä¸‹ãŒã£ãŸã¨ã„ã†ç ”ç©¶ãŒã‚ã‚‹ã€

---

### é‡è¦ãªæ³¨æ„äº‹é …ï¼ˆãƒ†ãƒ¼ãƒåˆ¥ï¼‰

- **éºä¼å­ã¯ã€Œãƒªã‚¹ã‚¯ã®å®£å‘Šã€ã§ã¯ãªãã€Œãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒã‚¤ãƒ³ãƒˆã®æç¤ºã€ã¨ã—ã¦ä½¿ã†**
- **è¡€æ¶²ã¯ã€Œä»Šã®ãƒ¢ãƒ¼ãƒ‰ã€ã€Œãƒœãƒˆãƒ«ãƒãƒƒã‚¯é …ç›®ã€ã‚’1ã€œ3å€‹ã«çµã£ã¦æç¤º**
- **ãƒã‚¤ã‚¿ãƒ«ã¯ã€Œæ—¥ã€…ã®è¡Œå‹• â†’ å°†æ¥ã®çŠ¶æ…‹ã€ã®æ©‹æ¸¡ã—ã«ä½¿ã†**
- **ã‚¹ã‚³ã‚¢ã‚„ãƒ©ãƒ™ãƒ«ã¯ã€ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å‘ä¸Šã®ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ä½¿ã†**
- **å¿…ãšã€Œã“ã‚Œã¯åŒ»å­¦çš„è¨ºæ–­ã§ã¯ãªãã€ä¸€èˆ¬çš„ãªå‚¾å‘ã«åŸºã¥ãå‚è€ƒæƒ…å ±ã€ã¨æ˜è¨˜**

====================
â–  é¸æŠå¼è³ªå•ã®ãƒ«ãƒ¼ãƒ«
====================

- ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¿½åŠ æƒ…å ±ã‚’é›†ã‚ãŸã„ã€ã€Œæ¬¡ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸ã‚“ã§ã»ã—ã„ã€ã¨ãã«ã ã‘ã€
  ã€é¸æŠã€‘ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä½¿ã†ã€‚
- ã™ã¹ã¦ã®è³ªå•ã‚’é¸æŠå¼ã«ã™ã‚‹å¿…è¦ã¯ãªã„ã€‚
  è»½ã„å…±æ„Ÿã‚„ç¢ºèªã¯æ™®é€šã®ãƒ†ã‚­ã‚¹ãƒˆè³ªå•ã§ã‚ˆã„ã€‚
- é¸æŠè‚¢ã‚’å‡ºã™ã¨ãã¯ã€å¿…ãšã€Œãã®ä»–/ã‚¹ã‚­ãƒƒãƒ—ã€ã«ã‚ãŸã‚‹é¸æŠè‚¢ã‚’1ã¤å«ã‚ã‚‹ã€‚
- é¸æŠå¾Œã«è‡ªç”±å…¥åŠ›ã§è£œè¶³ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã‚ˆã†ãªä¸€è¨€ã‚’æ·»ãˆã‚‹ã¨ã‚ˆã„ï¼š
  ä¾‹ï¼šã€Œä¸€ç•ªè¿‘ã„ã‚‚ã®ã‚’é¸ã‚“ã§ã€å¿…è¦ãªã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è£œè¶³ã—ã¦ã­ã€‚ã€

====================
â–  å¿ƒç†çš„ãªãƒˆãƒ¼ãƒ³ã¨ã‚¹ã‚¿ã‚¤ãƒ«
====================

- çµµæ–‡å­—ï¼ˆğŸ§¬ ğŸ©¸ ğŸ’ª âœ¨ãªã©ï¼‰ã‚’é©åº¦ã«ä½¿ã„ã€ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã ãŒåªšã³ãªã„ãƒˆãƒ¼ãƒ³ã§è©±ã™ã€‚
- å°‚é–€ç”¨èªã¯ä½¿ã£ã¦ã‚ˆã„ãŒã€å¿…ãšä¸€åº¦ã¯æ—¥å¸¸èªã§è¨€ã„æ›ãˆã‚‹ã€‚
- ã€Œã€œã—ãŸæ–¹ãŒã„ã„ã‚ˆã€ã§ã¯ãªãã€
  ã€Œã‚ãªãŸã®â—¯â—¯ã®æ•°å€¤/ä½“è³ªã ã¨ã€â–³â–³ã‚’å¤‰ãˆã‚‹ã¨åŠ¹æœãŒå‡ºã‚„ã™ã„ã‹ã‚‰ã€ã¾ãšã“ã“ã‹ã‚‰ãŒãŠã™ã™ã‚ã€‚ã€
  ã®ã‚ˆã†ã«ã€"ãªãœãã®äººã«ã¨ã£ã¦ãã‚ŒãŒãƒ™ã‚¹ãƒˆãªã®ã‹"ã‚’ã‚»ãƒƒãƒˆã§ä¼ãˆã‚‹ã€‚
- ã™ã§ã«ã§ãã¦ã„ã‚‹ã“ã¨ã‚„è‰¯ã„ç‚¹ã‚’1ã¤ã¯æ‹¾ã„ã€
  ã€Œã“ã“ãŒã§ãã¦ã„ã‚‹ã‹ã‚‰ã€ã‚ã¨ã¯â—¯â—¯ã‚’æ•´ãˆã‚‹ã ã‘ã§ã‹ãªã‚Šå¤‰ã‚ã‚‹ã‚ˆã€
  ã¨è‡ªå·±åŠ¹åŠ›æ„Ÿã‚’ä¸Šã’ã‚‹ã€‚
- ã€Œã“ã“ã ã‘å¤‰ãˆã‚‹ã¨ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãŒå¤§ãã„ã€ã¨ã„ã†ãƒ¬ãƒãƒ¬ãƒƒã‚¸ç®‡æ‰€ã‚’æ˜ç¤ºã™ã‚‹ã€‚
- ã€Œã©ã“ã‹ã‚‰ä¸€ç·’ã«æ•´ãˆã‚‹ï¼Ÿã€ã®ã‚ˆã†ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸»ä½“ã§é¸ã°ã›ã‚‹è¨€ã„å›ã—ã‚’ä½¿ã†ã€‚
- æƒ…å ±é‡ãŒå¤šããªã‚Šãã†ãªã¨ãã¯ã€
  - ç®‡æ¡æ›¸ã
  - ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã—ï¼ˆã€â—¯â—¯ã€‘ï¼‰
  ã‚’ä½¿ã„ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«ã‚‚ãƒ‘ãƒƒã¨è¦ç‚¹ãŒã¤ã‹ã‚ã‚‹å½¢ã«ã™ã‚‹ã€‚

====================
â–  æ³¨æ„äº‹é …
====================

- åŒ»ç™‚è¨ºæ–­ã‚„æ²»ç™‚è¡Œç‚ºã¯è¡Œã‚ãšã€ã‚ãã¾ã§å¥åº·ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã«ç•™ã‚ã‚‹ã€‚
- ç‰¹ã«ç—‡çŠ¶ç›¸è«‡ã«ãŠã„ã¦ã¯ã€æ¯å›ã€Œã“ã‚Œã¯è¨ºæ–­ãƒ»æ²»ç™‚ã§ã¯ãªã„ã€ã“ã¨ã‚’æ˜ç¤ºã™ã‚‹ã€‚
- æ˜ã‚‰ã‹ã«æ·±åˆ»ãªç•°å¸¸å€¤ã‚„ç—‡çŠ¶ãŒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹å ´åˆã¯ã€
  ã€ŒåŒ»å¸«ã®è¨ºå¯Ÿã‚’å—ã‘ã‚‹ã¹ãçŠ¶æ³ã€ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¢ºã«ä¼ãˆã‚‹ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾çŠ¶ãƒ»ã“ã‚Œã¾ã§ã®åŠªåŠ›ã‚’ã¾ãšè‚¯å®šã—ã¤ã¤ã€
  æœ€ã‚‚ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãŒå¤§ãã„å°‘æ•°ã®æ”¹å–„ãƒã‚¤ãƒ³ãƒˆã«çµã£ã¦ææ¡ˆã™ã‚‹ã€‚
"""


def build_initial_context(blood_data: Optional[List[Dict]], available_gene_categories: List[str]) -> str:
    """åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆè¡€æ¶²ãƒ‡ãƒ¼ã‚¿ + éºä¼å­ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒªã‚¹ãƒˆï¼‰"""
    context_parts = []

    # è¡€æ¶²ãƒ‡ãƒ¼ã‚¿
    if blood_data:
        context_parts.append("ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡€æ¶²æ¤œæŸ»çµæœã€‘")

        normal_items = []
        attention_items = []
        abnormal_items = []

        for item in blood_data:
            status = item.get('status', '').lower()
            item_text = f"- {item.get('nameJp', item.get('key'))}: {item.get('value')} {item.get('unit')} (åŸºæº–å€¤: {item.get('reference')})"

            if status in ['æ­£å¸¸', 'normal']:
                normal_items.append(item_text)
            elif status in ['æ³¨æ„', 'caution', 'è¦æ³¨æ„']:
                attention_items.append(item_text)
            else:
                abnormal_items.append(item_text)

        # ç•°å¸¸å€¤ã‚’å„ªå…ˆè¡¨ç¤º
        if abnormal_items:
            context_parts.append("\nã€è¦æ³¨æ„ã€‘ä»¥ä¸‹ã®é …ç›®ãŒç•°å¸¸å€¤ã§ã™ï¼š")
            context_parts.extend(abnormal_items)

        if attention_items:
            context_parts.append("\nã€æ³¨æ„ã€‘ä»¥ä¸‹ã®é …ç›®ãŒåŸºæº–å€¤å¤–ã§ã™ï¼š")
            context_parts.extend(attention_items)

        if normal_items:
            context_parts.append(f"\nã€æ­£å¸¸ç¯„å›²ã€‘{len(normal_items)}é …ç›®ãŒæ­£å¸¸ç¯„å›²å†…")

    # åˆ©ç”¨å¯èƒ½ãªéºä¼å­ã‚«ãƒ†ã‚´ãƒªãƒ¼
    if available_gene_categories:
        context_parts.append("\n\nã€åˆ©ç”¨å¯èƒ½ãªéºä¼å­ãƒ‡ãƒ¼ã‚¿ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€‘")
        context_parts.append("ä»¥ä¸‹ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®éºä¼å­æƒ…å ±ã‚’è¦æ±‚ã§ãã¾ã™ï¼š")
        for category in available_gene_categories:
            context_parts.append(f"- {category}")
        context_parts.append("\nå¿…è¦ã«å¿œã˜ã¦ã€ŒğŸ§¬ [ã‚«ãƒ†ã‚´ãƒªãƒ¼å]ã«é–¢ã™ã‚‹éºä¼å­æƒ…å ±ã€ã®å½¢å¼ã§è¦æ±‚ã—ã¦ãã ã•ã„ã€‚")

    return "\n".join(context_parts)


def build_gene_data_context(gene_data: Dict) -> str:
    """éºä¼å­ãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ2æ®µéšæŠ½å‡ºå¯¾å¿œ + è‡ªå‹•æ¤œå‡ºå¯¾å¿œï¼‰"""
    context_parts = ["ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éºä¼å­ãƒ‡ãƒ¼ã‚¿ã€‘"]
    has_data = False

    for category, markers in gene_data.items():
        # ç©ºã®ãƒãƒ¼ã‚«ãƒ¼ãƒªã‚¹ãƒˆã‚’æ¤œå‡º
        if not markers:
            context_parts.append(f"\nâ–  {category}: ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆå°ã‚«ãƒ†ã‚´ãƒªãƒ¼åãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼‰")
            continue

        context_parts.append(f"\nâ–  {category}")
        has_data = True

        # è‡ªå‹•æ¤œå‡ºå½¢å¼: markers ãŒè¾æ›¸ï¼ˆå˜ä¸€ãƒãƒ¼ã‚«ãƒ¼ï¼‰ã®å ´åˆ
        # å¾“æ¥å½¢å¼: markers ãŒé…åˆ—ï¼ˆè¤‡æ•°ãƒãƒ¼ã‚«ãƒ¼ï¼‰ã®å ´åˆ
        if isinstance(markers, dict):
            # è‡ªå‹•æ¤œå‡ºå½¢å¼: {title, genotypes, impact} ã®è¾æ›¸
            marker = markers
            title = marker.get('title', category)  # titleãŒãªã‘ã‚Œã°ã‚«ãƒ†ã‚´ãƒªãƒ¼åã‚’ä½¿ç”¨

            if 'genotypes' in marker:
                genotypes = marker.get('genotypes', {})
                impact = marker.get('impact', {})

                context_parts.append(f"  - {title}")

                # éºä¼å­å‹ã‚’è¡¨ç¤º
                for snp_id, genotype in genotypes.items():
                    context_parts.append(f"    {snp_id}: {genotype}")

                # å½±éŸ¿ã‚¹ã‚³ã‚¢ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
                if impact:
                    protective = impact.get('protective', 0)
                    risk = impact.get('risk', 0)
                    neutral = impact.get('neutral', 0)
                    score = impact.get('score', 0)

                    context_parts.append(f"    å½±éŸ¿: ä¿è­·{protective}/ãƒªã‚¹ã‚¯{risk}/ä¸­ç«‹{neutral} (ã‚¹ã‚³ã‚¢: {score:+d})")
            else:
                context_parts.append(f"  - {title}")
        elif isinstance(markers, list):
            # å¾“æ¥å½¢å¼: ãƒãƒ¼ã‚«ãƒ¼ã®é…åˆ—
            for marker in markers:
                title = marker.get('title', '')

                # 2æ®µéšæŠ½å‡ºå¯¾å¿œ: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ vs SNPsãƒ‡ãƒ¼ã‚¿
                if 'genotypes' in marker:
                    # Pattern 1: SNPsãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼ˆç¬¬2æ®µéšï¼‰
                    genotypes = marker.get('genotypes', {})
                    impact = marker.get('impact', {})

                    context_parts.append(f"  - {title}")

                    # éºä¼å­å‹ã‚’è¡¨ç¤º
                    for snp_id, genotype in genotypes.items():
                        context_parts.append(f"    {snp_id}: {genotype}")

                    # å½±éŸ¿ã‚¹ã‚³ã‚¢ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
                    if impact:
                        protective = impact.get('protective', 0)
                        risk = impact.get('risk', 0)
                        neutral = impact.get('neutral', 0)
                        score = impact.get('score', 0)

                        context_parts.append(f"    å½±éŸ¿: ä¿è­·{protective}/ãƒªã‚¹ã‚¯{risk}/ä¸­ç«‹{neutral} (ã‚¹ã‚³ã‚¢: {score:+d})")
                else:
                    # Pattern 2: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ã®å ´åˆï¼ˆç¬¬1æ®µéšï¼‰
                    # ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ã‚’ç°¡æ½”ã«ãƒªã‚¹ãƒˆè¡¨ç¤º
                    context_parts.append(f"  - {title}")
        else:
            # äºˆæœŸã—ãªã„å½¢å¼
            context_parts.append(f"  - (ä¸æ˜ãªå½¢å¼: {type(markers).__name__})")

    # å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒç©ºã®å ´åˆã®æ˜ç¤ºçš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    if not has_data:
        return "ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éºä¼å­ãƒ‡ãƒ¼ã‚¿ã€‘\nè¦æ±‚ã•ã‚ŒãŸéºä¼å­ãƒ‡ãƒ¼ã‚¿ãŒã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰è¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚å°ã‚«ãƒ†ã‚´ãƒªãƒ¼åã®å½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nâ€»ãƒ’ãƒ³ãƒˆ: å°ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯åŠè§’ã‚«ãƒ³ãƒã€Œ,ã€ã§åŒºåˆ‡ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"

    return "\n".join(context_parts)


def build_blood_data_context(blood_data: Dict) -> str:
    """è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ"""
    context_parts = ["ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡€æ¶²æ¤œæŸ»çµæœã€‘"]

    normal_items = []
    attention_items = []
    abnormal_items = []

    # é…åˆ—å½¢å¼ã®è¡€æ¶²ãƒ‡ãƒ¼ã‚¿ã«å¯¾å¿œ
    for item in blood_data:
        key = item.get('key', '')
        status = item.get('status', '').lower()
        item_text = f"- {item.get('nameJp', key)}: {item.get('value')} {item.get('unit')} (åŸºæº–å€¤: {item.get('reference')})"

        if status in ['æ­£å¸¸', 'normal']:
            normal_items.append(item_text)
        elif status in ['æ³¨æ„', 'caution', 'è¦æ³¨æ„']:
            attention_items.append(item_text)
        else:
            abnormal_items.append(item_text)

    # ç•°å¸¸å€¤ã‚’å„ªå…ˆè¡¨ç¤º
    if abnormal_items:
        context_parts.append("\nã€è¦æ³¨æ„ã€‘ä»¥ä¸‹ã®é …ç›®ãŒç•°å¸¸å€¤ã§ã™ï¼š")
        context_parts.extend(abnormal_items)

    if attention_items:
        context_parts.append("\nã€æ³¨æ„ã€‘ä»¥ä¸‹ã®é …ç›®ãŒåŸºæº–å€¤å¤–ã§ã™ï¼š")
        context_parts.extend(attention_items)

    if normal_items:
        context_parts.append(f"\nã€æ­£å¸¸ç¯„å›²ã€‘{len(normal_items)}é …ç›®ãŒæ­£å¸¸ç¯„å›²å†…")

    return "\n".join(context_parts)


def build_vital_data_context(vital_data: Dict) -> str:
    """ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆHealthKitãƒ‡ãƒ¼ã‚¿ï¼‰ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ"""
    context_parts = ["ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€æ–°7æ—¥é–“ï¼‰ã€‘"]

    # ä½“çµ„æˆç³»
    body_metrics = []
    if vital_data.get('bodyMass'):
        body_metrics.append(f"- ä½“é‡: {vital_data['bodyMass']:.1f} kg")
    if vital_data.get('height'):
        body_metrics.append(f"- èº«é•·: {vital_data['height']:.1f} cm")
    if vital_data.get('bodyFatPercentage'):
        body_metrics.append(f"- ä½“è„‚è‚ªç‡: {vital_data['bodyFatPercentage']*100:.1f}%")
    if vital_data.get('leanBodyMass'):
        body_metrics.append(f"- é™¤è„‚è‚ªä½“é‡: {vital_data['leanBodyMass']:.1f} kg")
    if body_metrics:
        context_parts.append("\nã€ä½“çµ„æˆã€‘")
        context_parts.extend(body_metrics)

    # å¿ƒè‡“ãƒ»å¾ªç’°å™¨ç³»
    cardiac_metrics = []
    if vital_data.get('restingHeartRate'):
        cardiac_metrics.append(f"- å®‰é™æ™‚å¿ƒæ‹æ•°: {vital_data['restingHeartRate']:.0f} bpm")
    if vital_data.get('vo2Max'):
        cardiac_metrics.append(f"- VO2Max: {vital_data['vo2Max']:.1f} ml/kg/min")
    if vital_data.get('heartRateVariability'):
        cardiac_metrics.append(f"- å¿ƒæ‹å¤‰å‹• (HRV): {vital_data['heartRateVariability']:.0f} ms")
    if vital_data.get('heartRate'):
        cardiac_metrics.append(f"- å¿ƒæ‹æ•°: {vital_data['heartRate']:.0f} bpm")
    if cardiac_metrics:
        context_parts.append("\nã€å¿ƒè‡“ãƒ»å¾ªç’°å™¨ã€‘")
        context_parts.extend(cardiac_metrics)

    # æ´»å‹•é‡ç³»
    activity_metrics = []
    if vital_data.get('activeEnergyBurned'):
        activity_metrics.append(f"- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ­ãƒªãƒ¼: {vital_data['activeEnergyBurned']:.0f} kcal")
    if vital_data.get('exerciseTime'):
        activity_metrics.append(f"- ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºæ™‚é–“: {vital_data['exerciseTime']:.0f} åˆ†")
    if vital_data.get('stepCount'):
        activity_metrics.append(f"- æ­©æ•°: {vital_data['stepCount']:.0f} steps")
    if activity_metrics:
        context_parts.append("\nã€æ´»å‹•é‡ã€‘")
        context_parts.extend(activity_metrics)

    # ç§»å‹•è·é›¢ç³»
    distance_metrics = []
    if vital_data.get('walkingRunningDistance'):
        distance_metrics.append(f"- æ­©è¡Œãƒ»ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°è·é›¢: {vital_data['walkingRunningDistance']:.2f} km")
    if vital_data.get('cyclingDistance'):
        distance_metrics.append(f"- ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°è·é›¢: {vital_data['cyclingDistance']:.2f} km")
    if distance_metrics:
        context_parts.append("\nã€ç§»å‹•è·é›¢ã€‘")
        context_parts.extend(distance_metrics)

    return "\n".join(context_parts)


def build_available_categories_context(available_categories: List[str]) -> str:
    """åˆ©ç”¨å¯èƒ½ãªéºä¼å­ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ"""
    context_parts = ["ã€åˆ©ç”¨å¯èƒ½ãªéºä¼å­ãƒ‡ãƒ¼ã‚¿ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€‘"]
    context_parts.append("ä»¥ä¸‹ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®éºä¼å­æƒ…å ±ã‚’è¦æ±‚ã§ãã¾ã™ï¼š")
    for category in available_categories:
        context_parts.append(f"- {category}")
    context_parts.append("\nå¿…è¦ã«å¿œã˜ã¦ã€ŒğŸ§¬ [ã‚«ãƒ†ã‚´ãƒªãƒ¼å]ã«é–¢ã™ã‚‹éºä¼å­æƒ…å ±ã€ã®å½¢å¼ã§è¦æ±‚ã—ã¦ãã ã•ã„ã€‚")
    return "\n".join(context_parts)


def call_openai(client: OpenAI, messages: List[Dict], max_retries: int = 3) -> str:
    """OpenAI APIã‚’å‘¼ã³å‡ºã—ï¼ˆãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆå¯¾ç­–ä»˜ãï¼‰"""
    print(f"ğŸ¤– Calling OpenAI API with {len(messages)} messages")

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’æ¦‚ç®—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    total_chars = sum(len(msg.get('content', '')) for msg in messages)
    estimated_tokens = total_chars // 4
    print(f"ğŸ“Š Estimated tokens: ~{estimated_tokens}")

    last_error = None

    for attempt in range(max_retries):
        try:
            response = client.chat.completions.create(
                model="gpt-5.1-chat-latest",
                messages=messages,
                max_completion_tokens=2500  # v8: 3ãƒ¬ã‚¤ãƒ¤ãƒ¼å¿œç­”ã«å¯¾å¿œã™ã‚‹ãŸã‚å¢—åŠ ï¼ˆ1500â†’2500ï¼‰
            )

            assistant_message = response.choices[0].message.content

            # ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’ãƒ­ã‚°å‡ºåŠ›
            usage = response.usage
            print(f"ğŸ“Š Token usage: prompt={usage.prompt_tokens}, completion={usage.completion_tokens}, total={usage.total_tokens}")

            return assistant_message

        except Exception as e:
            last_error = e
            error_str = str(e).lower()

            # ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤
            if "rate_limit" in error_str or "429" in str(e) or "rate limit" in error_str:
                wait_time = (2 ** attempt) + 1  # 1ç§’, 3ç§’, 5ç§’
                print(f"âš ï¸ Rate limit hit (attempt {attempt + 1}/{max_retries}), waiting {wait_time}s...")
                time.sleep(wait_time)
                continue

            # ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯ã™ãã«raise
            print(f"âŒ OpenAI API error: {str(e)}")
            raise

    # æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’è¶…ãˆãŸå ´åˆ
    print(f"âŒ Max retries ({max_retries}) exceeded. Last error: {str(last_error)}")
    raise last_error


def split_response_into_chunks(response_text: str) -> list:
    """ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Šã€Œ<<<CHUNK>>>ã€ã§ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ã€‚å¤±æ•—æ™‚ã¯å…¨ä½“ã‚’1ãƒãƒ£ãƒ³ã‚¯ã«"""
    # ã€Œ<<<CHUNK>>>ã€ã§ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ†å‰²
    if '<<<CHUNK>>>' in response_text:
        chunks = [chunk.strip() for chunk in response_text.split('<<<CHUNK>>>') if chunk.strip()]
        # ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³X:ã€‘ã®ãƒ©ãƒ™ãƒ«ã‚’é™¤å»ï¼ˆå‡ºåŠ›ã«ã¯ä¸è¦ï¼‰
        cleaned_chunks = []
        for chunk in chunks:
            # ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ã‚ãªãŸã®åˆ†æã€‘ã®ã‚ˆã†ãªè¡Œã‚’é™¤å»
            lines = chunk.split('\n')
            filtered_lines = [line for line in lines if not line.strip().startswith('ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³')]
            cleaned_chunk = '\n'.join(filtered_lines).strip()
            if cleaned_chunk:
                cleaned_chunks.append(cleaned_chunk)
        return cleaned_chunks if cleaned_chunks else [response_text.strip()]

    # ã€Œ<<<CHUNK>>>ã€ãŒãªã„å ´åˆã¯å…¨ä½“ã‚’1ãƒãƒ£ãƒ³ã‚¯ã«
    return [response_text.strip()]


def cors_headers():
    """CORS ãƒ˜ãƒƒãƒ€ãƒ¼"""
    return {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'OPTIONS,POST,GET'
    }
